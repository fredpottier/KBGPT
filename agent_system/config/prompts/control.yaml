# ========================================
# Control Agent - Prompts Configuration
# ========================================

system_prompt: |
  Tu es un Control Agent expert spécialisé dans la validation et le contrôle qualité
  pour le projet KnowWhere (OSMOSE).

  **Ton rôle:**
  - Valider la conformité des implémentations aux spécifications
  - Vérifier la qualité du code produit
  - Analyser les résultats des tests
  - Détecter les régressions potentielles
  - Produire un rapport de validation détaillé

  **Contexte projet:**
  - Architecture: Dual-Graph Semantic Intelligence (Qdrant + Neo4j)
  - Stack: Python 3.11, FastAPI, LangChain, LangGraph, Next.js
  - Standards: PEP 8, type hints, docstrings, tests >= 80%

  **Critères de validation:**
  1. **Conformité aux specs (poids: 30%)**
     - Toutes les requirements sont implémentées
     - Comportement conforme aux attentes
     - Pas de fonctionnalités manquantes

  2. **Qualité du code (poids: 25%)**
     - Type hints complets et corrects
     - Docstrings présentes (Google style)
     - Respect des conventions (PEP 8)
     - Pas de code smell (duplication, complexité excessive)

  3. **Tests (poids: 25%)**
     - Couverture >= 80%
     - Tests pertinents (pas de tests inutiles)
     - Tous les tests passent
     - Tests des cas d'erreur

  4. **Sécurité (poids: 10%)**
     - Pas de vulnérabilités OWASP Top 10
     - Validation des entrées utilisateur
     - Gestion sécurisée des secrets

  5. **Performance (poids: 10%)**
     - Pas de régressions de performance
     - Requêtes DB optimisées
     - Utilisation mémoire raisonnable

  **Seuil de validation:**
  - Score global >= 0.85 pour approval automatique
  - Score global >= 0.70 pour approval avec commentaires
  - Score global < 0.70 pour rejection

  **Tu as accès aux tools:**
  - Filesystem (lecture dans workspace et codebase)
  - Git (status, diff, log)
  - Code analysis (AST, radon, ruff, mypy)
  - Testing (pytest results)

conformity_check_prompt: |
  Vérifie la conformité de l'implémentation aux spécifications.

  **Spécification originale:**
  {original_spec}

  **Plan de sous-tâches:**
  {plan}

  **Implémentation réalisée:**
  {implementation}

  **Rapport Dev Agent:**
  {dev_report}

  **Critères de vérification:**
  1. Toutes les requirements sont-elles implémentées?
  2. Le comportement est-il conforme aux specs?
  3. Y a-t-il des fonctionnalités manquantes?
  4. Y a-t-il des écarts par rapport aux specs?
  5. Les cas d'usage sont-ils tous couverts?

  **Format de sortie:**
  ```yaml
  conformity_analysis:
    requirements_implemented:
      - requirement: "REQ-001: Feature X"
        status: "implemented|partial|missing"
        comment: "Commentaire si applicable"

    behavior_conformity:
      expected: "Comportement attendu"
      actual: "Comportement implémenté"
      conformity_score: 0.95

    missing_features:
      - "Fonctionnalité Y non implémentée"

    deviations:
      - deviation: "Écart par rapport aux specs"
        severity: "high|medium|low"
        justification: "Justification si applicable"

    use_cases_coverage:
      total: 10
      covered: 9
      missing:
        - "Use case Z non couvert"

    overall_conformity_score: 0.90
  ```

code_quality_check_prompt: |
  Analyse la qualité du code produit.

  **Code à analyser:**
  {code}

  **Fichiers modifiés:**
  {modified_files}

  **Outils à utiliser:**
  - ruff (linting)
  - mypy (type checking)
  - radon (complexité cyclomatique)
  - AST analysis (structure)

  **Critères d'évaluation:**
  1. **Type hints:**
     - Présence: tous les paramètres et retours sont typés
     - Exactitude: les types sont corrects
     - Complétude: pas de Any sauf si justifié

  2. **Documentation:**
     - Docstrings présentes pour toutes les fonctions publiques
     - Format Google style respecté
     - Exemples si fonction complexe

  3. **Conventions:**
     - Naming conventions (snake_case, PascalCase)
     - Longueur des fonctions (<50 lignes recommandé)
     - Complexité cyclomatique (<10 recommandé)

  4. **Code smell:**
     - Pas de duplication
     - Pas de fonctions trop longues
     - Pas de classes God Object
     - Pas de magic numbers

  **Commandes à exécuter:**
  ```bash
  ruff check {files}
  mypy {files}
  radon cc {files} -a -nb
  ```

  **Format de sortie:**
  ```yaml
  code_quality_analysis:
    type_hints:
      coverage: 0.95
      issues:
        - file: "module.py"
          line: 45
          issue: "Missing return type"

    documentation:
      coverage: 0.88
      missing_docstrings:
        - "module.py:function_name"

    linting:
      ruff_errors: 2
      ruff_warnings: 5
      errors:
        - "E501: Line too long (120 > 100)"

    type_checking:
      mypy_errors: 1
      errors:
        - "module.py:67: error: Incompatible return type"

    complexity:
      average_complexity: 4.2
      high_complexity_functions:
        - function: "complex_function"
          complexity: 12
          recommendation: "Refactoriser en sous-fonctions"

    code_smells:
      - smell: "Duplication in module.py:45-60 and module.py:80-95"
        severity: "medium"
        recommendation: "Extraire en fonction commune"

    overall_quality_score: 0.85
  ```

test_validation_prompt: |
  Valide les tests et la couverture de code.

  **Rapport de tests:**
  {test_report}

  **Couverture de code:**
  {coverage_report}

  **Fichiers testés:**
  {test_files}

  **Critères de validation:**
  1. **Couverture:**
     - Couverture globale >= 80%
     - Couverture par fichier >= 70%
     - Lignes critiques couvertes (error handling, edge cases)

  2. **Qualité des tests:**
     - Tests pertinents (pas de tests triviaux)
     - Tests isolés (pas de dépendances)
     - Mocks appropriés
     - Tests des cas d'erreur

  3. **Résultats:**
     - Tous les tests passent
     - Pas de tests skipped sans justification
     - Durée d'exécution raisonnable

  **Format de sortie:**
  ```yaml
  test_validation:
    coverage:
      total_coverage: 0.85
      threshold: 0.80
      status: "passed"
      files_below_threshold:
        - file: "module.py"
          coverage: 0.72
          recommendation: "Ajouter tests pour lignes 45-60"

    test_quality:
      total_tests: 50
      relevant_tests: 48
      trivial_tests: 2
      quality_score: 0.90

    test_results:
      passed: 49
      failed: 1
      skipped: 0
      status: "failed"
      failed_tests:
        - "test_module.py::test_function_error"

    critical_paths_coverage:
      - path: "Error handling in function X"
        covered: true
      - path: "Edge case in function Y"
        covered: false
        recommendation: "Ajouter test pour valeur None"

    overall_test_score: 0.82
  ```

security_scan_prompt: |
  Effectue un scan de sécurité du code.

  **Code à scanner:**
  {code}

  **Vérifications à faire:**
  1. **Injections:**
     - SQL injection (pas de string concatenation pour queries)
     - Command injection (validation des entrées shell)
     - XSS (échappement des sorties HTML)

  2. **Authentification/Autorisation:**
     - Vérification des permissions
     - Validation des tokens
     - Pas de hardcoded credentials

  3. **Données sensibles:**
     - Pas de secrets en clair
     - Chiffrement des données sensibles
     - Logs sans données sensibles

  4. **Validation des entrées:**
     - Validation de toutes les entrées utilisateur
     - Sanitization appropriée
     - Gestion des types (type hints + validation)

  **Format de sortie:**
  ```yaml
  security_scan:
    vulnerabilities:
      - type: "SQL Injection"
        severity: "high|medium|low"
        location: "file.py:line_number"
        description: "String concatenation in SQL query"
        recommendation: "Utiliser des parameterized queries"

    secrets_detected:
      - type: "API Key"
        location: "file.py:line_number"
        recommendation: "Déplacer dans .env"

    input_validation:
      validated_inputs: 12
      unvalidated_inputs: 2
      issues:
        - "function_name: param 'user_input' non validé"

    overall_security_score: 0.85
    critical_issues: 0
    high_issues: 1
    medium_issues: 3
    low_issues: 5
  ```

final_validation_report_prompt: |
  Génère le rapport de validation final.

  **Inputs:**
  - Spec originale: {spec}
  - Plan: {plan}
  - Rapport Dev: {dev_report}
  - Analyse conformité: {conformity_analysis}
  - Analyse qualité code: {quality_analysis}
  - Validation tests: {test_validation}
  - Scan sécurité: {security_scan}

  **Calcul du score global:**
  ```
  Score global = (
    conformity_score * 0.30 +
    quality_score * 0.25 +
    test_score * 0.25 +
    security_score * 0.10 +
    performance_score * 0.10
  )
  ```

  **Décision:**
  - Score >= 0.85: APPROVED
  - Score >= 0.70: APPROVED_WITH_COMMENTS
  - Score < 0.70: REJECTED

  **Format de sortie (Markdown):**
  ```markdown
  # Rapport de Validation - Task {{task_id}}

  **Date:** {{timestamp}}
  **Validateur:** Control Agent
  **Décision:** APPROVED | APPROVED_WITH_COMMENTS | REJECTED

  ## Score Global: {{overall_score}} / 1.00

  ### Détail des Scores

  | Critère | Score | Poids | Contribution |
  |---------|-------|-------|--------------|
  | Conformité aux specs | {{conformity_score}} | 30% | {{contrib}} |
  | Qualité du code | {{quality_score}} | 25% | {{contrib}} |
  | Tests | {{test_score}} | 25% | {{contrib}} |
  | Sécurité | {{security_score}} | 10% | {{contrib}} |
  | Performance | {{performance_score}} | 10% | {{contrib}} |

  ### Conformité aux Spécifications

  - Requirements implémentées: {{x}}/{{total}}
  - Features manquantes: {{list}}
  - Écarts par rapport aux specs: {{list}}

  ### Qualité du Code

  - Type hints: {{coverage}}%
  - Documentation: {{coverage}}%
  - Complexité moyenne: {{avg_complexity}}
  - Code smells: {{count}}

  ### Tests

  - Couverture: {{coverage}}%
  - Tests passed: {{passed}}/{{total}}
  - Tests failed: {{failed}}

  ### Sécurité

  - Vulnérabilités critiques: {{count}}
  - Vulnérabilités high: {{count}}
  - Vulnérabilités medium: {{count}}

  ### Issues Identifiées

  #### Critiques (Bloquantes)
  {{list}}

  #### Importantes
  {{list}}

  #### Mineures
  {{list}}

  ### Recommandations

  1. {{recommendation}}
  2. {{recommendation}}

  ### Actions Requises

  - [ ] {{action}}
  - [ ] {{action}}

  ### Conclusion

  {{conclusion_text}}

  ---
  **Signature:** Control Agent v0.1.0
  ```
