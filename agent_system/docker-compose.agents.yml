version: '3.8'

services:
  agent-orchestrator:
    build:
      context: ../
      dockerfile: agent_system/Dockerfile.agents
    container_name: knowbase-agent-orchestrator
    hostname: agent-orchestrator

    environment:
      # LLM Configuration
      # IMPORTANT: Ne PAS définir ANTHROPIC_API_KEY ici !
      # Claude Code CLI doit utiliser OAuth (via ~/.claude/.credentials.json)
      # Si ANTHROPIC_API_KEY est définie, le CLI l'utilise EN PRIORITÉ sur OAuth
      # et cela consomme les crédits API payants au lieu du forfait Pro/Max

      # LangSmith Configuration
      - LANGSMITH_API_KEY=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
      - LANGSMITH_PROJECT=knowwhere-agents
      - LANGSMITH_TRACING=true
      - LANGSMITH_ENDPOINT=https://api.smith.langchain.com

      # Agent System Configuration
      - WORKSPACE_ROOT=/app/agent_system/data/workspace
      - AGENTS_CONFIG_PATH=/app/agent_system/config
      - PYTHONPATH=/app/agent_system/src:/app

      # DeepAgents Configuration
      - DEEPAGENTS_FILESYSTEM_SANDBOX=true
      - DEEPAGENTS_SHELL_WHITELIST_ONLY=true

      # Logging
      - LOG_LEVEL=INFO
      - LOG_FILE=/app/agent_system/data/agent_system.log

    volumes:
      # Repository Git complet (read-write pour git operations)
      - ../.git:/app/.git

      # Docker socket - permet de contrôler les containers du host
      # ATTENTION: Ceci donne accès Docker complet au container
      - //var/run/docker.sock:/var/run/docker.sock

      # Claude Code credentials (OAuth via abonnement Pro)
      # Permet d'utiliser Claude Code CLI sans API key payante
      # Sur Windows: utiliser USERPROFILE au lieu de HOME
      # Note: monté dans /home/agent car container tourne en non-root
      - ${USERPROFILE}/.claude:/home/agent/.claude

      # Code agent_system (read-write pour développement)
      - ./:/app/agent_system

      # Code source SAP_KB (read-write pour que Claude puisse modifier)
      - ../src:/app/src
      - ../tests:/app/tests
      - ../config:/app/config
      - ../doc:/app/doc
      - ../scripts:/app/scripts
      - ../frontend:/app/frontend

      # Fichiers racine du projet (pour docker-compose, etc.)
      - ../docker-compose.yml:/app/docker-compose.yml
      - ../docker-compose.infra.yml:/app/docker-compose.infra.yml
      - ../.env:/app/.env

      # Données persistantes
      - agent_plans:/app/agent_system/data/plans
      - agent_reports:/app/agent_system/data/reports
      - agent_workspace:/app/agent_system/data/workspace
      - agent_cache:/app/agent_system/data/cache
      - agent_checkpoints:/app/agent_system/data/checkpoints

    networks:
      - agent-network

    ports:
      - "9000:9000"  # Port pour future API agents (optionnel)

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  agent_plans:
    driver: local
  agent_reports:
    driver: local
  agent_workspace:
    driver: local
  agent_cache:
    driver: local
  agent_checkpoints:
    driver: local

networks:
  agent-network:
    driver: bridge
    name: knowbase-agent-network
