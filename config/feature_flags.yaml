# ===============================================================================
# üåä OSMOSE Feature Flags Configuration - SIMPLIFIED
# ===============================================================================
#
# Ce fichier contient UNIQUEMENT les flags r√©ellement utilis√©s dans le code.
# Les sections mortes (phase_1, phase_1_5) ont √©t√© supprim√©es.
#
# Usage:
#   from knowbase.config.feature_flags import is_feature_enabled
#   if is_feature_enabled("stratified_pipeline_v2"):
#       ...
#
# ===============================================================================

# ===============================================================================
# PIPELINE PRINCIPAL - Stratified V2
# ===============================================================================
# Pipeline actif pour l'ingestion standard (via /documents/import)

stratified_pipeline_v2:
  enabled: true

  # Frugality Guards
  max_concepts_per_document: 15
  max_concepts_hostile: 5
  max_relations_per_concept: 3

  # Promotion Policy
  strict_promotion: false
  promotion_threshold: 0.7
  abstention_log: true

  # Pointer Mode (anti-reformulation)
  enable_pointer_mode: true

  # V2.2 Extract-then-Structure
  pass1_v22: true

  # Pass 3 Configuration
  consolidation_similarity_threshold: 0.85
  enable_llm_validation: true

  # Calibration LLM
  llm_calibration:
    mode: "auto"
    auto_fallback:
      min_sample_size: 5
      min_score_spread: 0.03
      band_separation_threshold: 0.08
      conf_final_clamp_min: 0.15
      conf_final_clamp_max: 0.45
      percentile_low: 10
      percentile_mid: 50
      percentile_high: 75
    profile:
      name: "qwen3_14b"
      conf_threshold_original: 0.45
      conf_threshold_final: 0.35
      sink_band1_ceiling: 0.42
      sink_band3_floor: 0.52
      sink_band2_gap_min: 0.04
      margin_ambiguous: 0.05
      sink_signal_fort_threshold: 1.15


# ===============================================================================
# HYBRID INTELLIGENCE - Am√©liorations LLM
# ===============================================================================
# Flags pour les optimisations LLM (tous activ√©s par d√©faut)

hybrid_intelligence:
  # Route segments probl√©matiques vers LLM
  enable_hybrid_extraction: true
  low_quality_ner:
    entity_threshold: 3
    token_threshold: 200

  # Contexte document pour d√©sambigu√Øsation
  enable_document_context: true
  document_context:
    max_length: 500
    cache_enabled: true

  # LLM-as-a-Judge pour clustering
  enable_llm_judge_validation: true
  llm_judge:
    threshold: 0.85
    min_similarity: 0.75
    max_similarity: 0.95

  # Dictionnaires m√©tier NER
  enable_entity_ruler: true
  entity_ruler:
    global_ontologies: []
    enable_custom_tenant: true

  # Prefetch ontologie
  enable_ontology_prefetch: true
  ontology_prefetch:
    ttl_seconds: 3600
    max_entries_per_domain: 500

  # Enrichissement relations (D√âSACTIV√â - unifi√© sur Pass 2)
  enable_llm_relation_enrichment: false

  # Business Rules Engine
  enable_business_rules_engine: true


# ===============================================================================
# PHASE 2 - Hybrid Anchor Model
# ===============================================================================
# Configuration du Pass 2 (enrichissement asynchrone)

phase_2_hybrid_anchor:
  enabled: true
  pass2_mode: "background"

  anchor_config:
    min_fuzzy_score: 85
    min_approximate_score: 70
    reject_below_score: 70

  promotion_config:
    min_proto_concepts_for_stable: 2
    min_anchor_sections_for_stable: 2
    allow_singleton_if_high_signal: true
    high_signal_roles: ["requirement", "prohibition", "definition", "constraint", "obligation"]
    high_signal_modals: ["shall", "must", "required", "prohibited", "mandatory"]
    high_signal_sections: ["requirements", "security", "compliance", "sla", "constraints", "obligations"]
    high_signal_domains: ["gdpr", "security", "disaster_recovery", "sla", "compliance", "legal"]

  chunking_config:
    chunk_size_tokens: 256
    chunk_overlap_tokens: 64
    min_chunk_tokens: 50

  allowed_anchor_payload_fields: ["concept_id", "label", "role", "span", "chunk_id"]

  pass2_config:
    mode: "background"
    enabled_phases:
      - "corpus_promotion"
      - "structural_topics"
      - "classify_fine"
      - "enrich_relations"
      - "normative_extraction"
      - "semantic_consolidation"
      - "cross_doc"
    default_priority: 0

  classification_config:
    custom_patterns: {}

  search_config:
    chunk_weight: 0.6
    concept_weight: 0.4
    min_score: 0.5
    max_anchor_expansion: 5
    default_mode: "hybrid"

  navigation_layer:
    enable_document_context: true
    enable_section_context: true
    enable_window_context: false
    max_windows_per_document: 50
    max_mentions_per_concept: 100
    min_mention_count: 1


# ===============================================================================
# EXTRACTION V2 - Docling + Vision Gating
# ===============================================================================
# Pipeline d'extraction unifi√© (V1 supprim√©)

extraction_v2:
  enabled: true

  vision_config:
    enabled: true
    model: "gpt-4o"
    temperature: 0.0
    budget: null
    include_recommended: true

  gating_thresholds:
    vision_required: 0.60
    vision_recommended: 0.40

  supported_formats: ["pdf", "pptx", "docx", "xlsx"]

  cache:
    enabled: true
    version: "v5"


# ===============================================================================
# CLAIM-FIRST PIPELINE (Pivot √âpist√©mique)
# ===============================================================================
# Pipeline alternatif via /admin/claimfirst
# INV-8: Applicability over Truth
# INV-9: Conservative Subject Resolution
# INV-10: Discriminants D√©couverts

claimfirst_pipeline:
  enabled: false
  tenants:
    default: false
    pilot: true
  parallel_mode: true
  query_source: stratified

  # Subject Resolution (INV-8, INV-9)
  subject_resolution:
    embedding_threshold: 0.85
    delta_threshold: 0.06
    learned_confidence: 0.95
    use_llm_subjects: true

  # Context Extraction (INV-10)
  context_extraction:
    extract_qualifiers: true
    max_first_passages_chars: 5000
    qualifier_validation_threshold: 0.20

  # Claims
  extraction:
    min_unit_length: 30
    max_unit_length: 500
    batch_size: 10

  # Clustering (INV-6: conservateur)
  clustering:
    embedding_threshold: 0.85
    lexical_overlap_min: 0.3
    require_same_modality: true
    check_negation: true
    require_common_entity: true

  # Relations
  relations:
    detect_contradicts: true
    detect_refines: true
    detect_qualifies: true
    min_confidence: 0.7
    abstention_on_doubt: true

  # Persistance
  persistence:
    enabled: true
    bridge_layer_r: true

  # Query-Time Scoping (INV-8)
  query_scoping:
    enabled: true
    on_ambiguous: "disambiguate"
    max_disambiguation_candidates: 5
    suggest_inferred_aliases: true


# ===============================================================================
# NOTES D'ARCHITECTURE
# ===============================================================================
#
# OSMOSE utilise une architecture "1 instance = 1 client"
# - Isolation totale des donn√©es
# - Configuration sp√©cifique par client
# - Le tenant_id reste "default" (ou nom client pour les logs)
#
# Pipelines disponibles:
# 1. Stratified V2 (d√©faut) - via /documents/import
# 2. Claim-First (exp√©rimental) - via /admin/claimfirst
#
# ===============================================================================
