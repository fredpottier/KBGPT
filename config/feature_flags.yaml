# ===============================================================================
# üåä OSMOSE Feature Flags Configuration
# ===============================================================================
#
# Feature flags pour contr√¥ler le d√©ploiement progressif des fonctionnalit√©s.
# Format: feature_name: enabled (bool) ou configuration d√©taill√©e
#
# Usage:
#   from knowbase.config.feature_flags import is_feature_enabled
#   if is_feature_enabled("enable_hybrid_extraction"):
#       ...
#
# ===============================================================================

# ===============================================================================
# Phase 1.8 - LLM Hybrid Intelligence
# ===============================================================================

phase_1_8:
  # Global Phase 1.8 toggle (master switch)
  enabled: true

  # -------------------------------------------------------------------------
  # Sprint 1.8.1 - Extraction Concepts Hybrid
  # -------------------------------------------------------------------------

  # LOW_QUALITY_NER Routing: Route segments probl√©matiques vers LLM
  # Condition: < 3 entities ET > 200 tokens ‚Üí SMALL LLM
  # Impact: Rappel concepts 70% ‚Üí 85%
  enable_hybrid_extraction: true
  low_quality_ner:
    entity_threshold: 3      # Min entities pour consid√©rer "quality OK"
    token_threshold: 200     # Min tokens pour consid√©rer segment "long"

  # Document Context Global: G√©n√®re r√©sum√© pour d√©sambigu√Øsation
  # Impact: Precision +15-20%
  enable_document_context: true
  document_context:
    max_length: 500          # Max caract√®res pour le r√©sum√©
    cache_enabled: true      # Cache par document_id

  # LLM-as-a-Judge: Validation clustering via LLM (KGGen-inspired)
  # Impact: R√©duit faux positifs clustering -47%
  enable_llm_judge_validation: true
  llm_judge:
    threshold: 0.85          # Seuil confidence pour merger
    min_similarity: 0.75     # Min similarity pour consid√©rer LLM
    max_similarity: 0.95     # Max similarity pour auto-merge

  # -------------------------------------------------------------------------
  # Sprint 1.8.1c - Dictionnaires M√©tier NER (EntityRuler)
  # -------------------------------------------------------------------------

  # EntityRuler: Dictionnaires m√©tier pr√©charg√©s
  # Impact: Precision NER 70% ‚Üí 85-90%
  enable_entity_ruler: true
  entity_ruler:
    # Dictionnaires globaux √† charger
    # Note: Aucun dictionnaire pr√©d√©fini (solution domain-agnostic)
    # Les ontologies sont apprises progressivement via les documents import√©s
    # ou configur√©es via le Domain Context par le client
    global_ontologies: []
    # Support custom tenant (permet de charger des ontologies sp√©cifiques)
    enable_custom_tenant: true

  # -------------------------------------------------------------------------
  # Sprint 1.8.2 - Gatekeeper Prefetch Ontology
  # -------------------------------------------------------------------------

  # Prefetch Ontology: Cache ontologie par type document
  # Impact: Cache hit rate 50% ‚Üí 70%, LLM calls -20%
  enable_ontology_prefetch: true
  ontology_prefetch:
    ttl_seconds: 3600        # 1 heure
    max_entries_per_domain: 500

  # -------------------------------------------------------------------------
  # Sprint 1.8.3 - Relations LLM Smart Enrichment
  # -------------------------------------------------------------------------

  # Enrichissement Relations: LLM sur zone grise (0.4-0.6 confidence)
  # Impact: Precision relations 60% ‚Üí 80%, Rappel 50% ‚Üí 70%
  # D√âSACTIV√â 2026-01-01: Unifi√© sur Pass 2 ENRICH_RELATIONS (ADR-compliant)
  # Voir doc/ongoing/CONSISTENCY_AUDIT_2026-01.md
  enable_llm_relation_enrichment: false
  relation_enrichment:
    min_confidence: 0.4      # Zone grise min
    max_confidence: 0.6      # Zone grise max
    batch_size: 50           # Paires par appel LLM
    max_batches: 20          # Budget cap

  # -------------------------------------------------------------------------
  # Sprint 1.8.4 - Business Rules Engine
  # -------------------------------------------------------------------------

  # Business Rules: Validation m√©tier custom par tenant
  # Impact: Diff√©renciateur march√© vs Copilot/Gemini
  enable_business_rules_engine: true


# ===============================================================================
# Phase 2 - Hybrid Anchor Model Architecture
# ===============================================================================
# ADR: doc/ongoing/ADR_HYBRID_ANCHOR_MODEL.md
# Objectif: R√©duire temps traitement de 35+ min √† ~10 min par document

phase_2_hybrid_anchor:
  # Global toggle
  enabled: true

  # -------------------------------------------------------------------------
  # Pass 2 Mode Configuration
  # -------------------------------------------------------------------------
  # inline: Ex√©cute Pass 2 imm√©diatement apr√®s Pass 1 (mode Burst GPU)
  # background: Job asynchrone via RQ worker (mode normal)
  # scheduled: Batch nocturne (corpus stable)
  pass2_mode: "background"

  # -------------------------------------------------------------------------
  # Anchor Configuration
  # -------------------------------------------------------------------------
  anchor_config:
    # Seuil fuzzy matching pour anchor valide
    min_fuzzy_score: 85
    # Marquer approximate si score < seuil mais > min_approximate
    min_approximate_score: 70
    # Rejeter anchor si score < min_approximate
    reject_below_score: 70

  # -------------------------------------------------------------------------
  # Promotion Configuration (ProtoConcept ‚Üí CanonicalConcept)
  # -------------------------------------------------------------------------
  promotion_config:
    # Crit√®res pour "stable" (promu avec confiance)
    min_proto_concepts_for_stable: 2
    min_anchor_sections_for_stable: 2

    # Voie d'exception pour singletons critiques
    allow_singleton_if_high_signal: true

    # R√¥les anchor consid√©r√©s "high-signal"
    high_signal_roles:
      - "requirement"
      - "prohibition"
      - "definition"
      - "constraint"
      - "obligation"

    # Modaux normatifs pour d√©tection high-signal
    high_signal_modals:
      - "shall"
      - "must"
      - "required"
      - "prohibited"
      - "mandatory"

    # Sections critiques pour high-signal
    high_signal_sections:
      - "requirements"
      - "security"
      - "compliance"
      - "sla"
      - "constraints"
      - "obligations"

    # Domaines high-value
    high_signal_domains:
      - "gdpr"
      - "security"
      - "disaster_recovery"
      - "sla"
      - "compliance"
      - "legal"

  # -------------------------------------------------------------------------
  # Chunking Configuration (Document-Centric)
  # -------------------------------------------------------------------------
  chunking_config:
    chunk_size_tokens: 256       # R√©duit de 512 pour meilleure granularit√©
    chunk_overlap_tokens: 64     # Overlap pour continuit√© contextuelle
    min_chunk_tokens: 50         # Minimum pour √©viter chunks trop petits

  # -------------------------------------------------------------------------
  # Payload Qdrant - Champs autoris√©s (Invariant d'Architecture)
  # -------------------------------------------------------------------------
  # IMPORTANT: Ne JAMAIS ajouter d'autres champs dans anchored_concepts
  allowed_anchor_payload_fields:
    - "concept_id"
    - "label"
    - "role"
    - "span"
    - "chunk_id"

  # -------------------------------------------------------------------------
  # Pass 2 Configuration (Enrichissement)
  # -------------------------------------------------------------------------
  pass2_config:
    # Mode d'ex√©cution: inline | background | scheduled | disabled
    mode: "background"
    # Phases activ√©es
    # NOTE 2025-01-01: enrich_relations r√©activ√© avec impl√©mentation ADR-compliant
    # Segment-first extraction avec quote + chunk_id + span obligatoires
    # Voir: src/knowbase/relations/segment_window_relation_extractor.py
    # NOTE 2026-01-19: Ajout structural_topics (Pass 2a) requis pour Pass 3
    enabled_phases:
      - "corpus_promotion"       # Pass 2.0: Promotion unifi√©e (ADR_UNIFIED_CORPUS_PROMOTION)
      - "structural_topics"      # Pass 2a: Topics + HAS_TOPIC + COVERS (requis pour Pass 3)
      - "classify_fine"          # Pass 2b-1: Classification fine des concepts
      - "enrich_relations"       # Pass 2b-2: ADR-compliant implementation
      - "normative_extraction"   # Pass 2c: NormativeRule + SpecFact (ADR_NORMATIVE_RULES_SPEC_FACTS)
      - "semantic_consolidation" # Pass 3: Semantic Consolidation (proven relations)
      - "cross_doc"              # Cross-document linking (Entity Resolution)
    # Priorit√© jobs background
    default_priority: 0

  # -------------------------------------------------------------------------
  # Classification Configuration
  # -------------------------------------------------------------------------
  classification_config:
    # Patterns custom par tenant (optionnel)
    custom_patterns: {}

  # -------------------------------------------------------------------------
  # Hybrid Search Configuration (Phase 7)
  # -------------------------------------------------------------------------
  search_config:
    # Poids pour fusion chunks/concepts
    chunk_weight: 0.6
    concept_weight: 0.4
    # Score minimum pour inclusion
    min_score: 0.5
    # Max chunks additionnels via anchor expansion
    max_anchor_expansion: 5
    # Mode par d√©faut: chunks_only | concepts_only | hybrid | anchor_first
    default_mode: "hybrid"

  # -------------------------------------------------------------------------
  # Navigation Layer Configuration
  # -------------------------------------------------------------------------
  # ADR: doc/ongoing/ADR_NAVIGATION_LAYER.md
  # Couche de navigation non-s√©mantique pour exploration corpus-level
  navigation_layer:
    # Feature toggles
    enable_document_context: true    # DocumentContext - 1 par document
    enable_section_context: true     # SectionContext - ~5-20 par document
    enable_window_context: false     # WindowContext - D√âSACTIV√â par d√©faut (ADR)

    # Budgets (pour √©viter explosion)
    max_windows_per_document: 50     # Cap WindowContext par document
    max_mentions_per_concept: 100    # Top-N mentions par concept

    # Seuils
    min_mention_count: 1             # Min mentions pour cr√©er lien MENTIONED_IN


# ===============================================================================
# Extraction V2 - Pipeline Unifi√© Docling + Vision Gating
# ===============================================================================
# ADR: doc/OSMOSIS_EXTRACTION_V2_DECISIONS.md
# Objectif: Pipeline d'extraction unifi√© avec Vision Gating V4

extraction_v2:
  # Pipeline V2 actif par defaut (V1 supprime - Cleanup 2025-01-05)
  enabled: true

  # Configuration Vision
  vision_config:
    # Mod√®le Vision √† utiliser
    model: "gpt-4o"
    # Temp√©rature pour g√©n√©ration
    temperature: 0.0
    # Budget max pages Vision par document (null = illimit√©)
    budget: null
    # Inclure pages RECOMMENDED (pas seulement REQUIRED)
    include_recommended: true

  # Seuils de gating
  gating_thresholds:
    # Score VNS >= ce seuil ‚Üí VISION_REQUIRED
    vision_required: 0.60
    # Score VNS >= ce seuil ‚Üí VISION_RECOMMENDED
    vision_recommended: 0.40

  # Formats support√©s
  supported_formats:
    - "pdf"
    - "pptx"
    - "docx"
    - "xlsx"

  # Cache
  cache:
    enabled: true
    version: "v2"


# ===============================================================================
# Phases Ant√©rieures (R√©f√©rence)
# ===============================================================================

phase_1:
  # Phase 1.0-1.7 features (toutes actives en production)
  semantic_extraction: true
  multilingual_ner: true
  concept_clustering: true
  neo4j_graph: true
  qdrant_vectors: true

phase_1_5:
  # Agent architecture
  agent_architecture: true
  supervisor_agent: true
  extractor_orchestrator: true


# ===============================================================================
# Architecture de D√©ploiement
# ===============================================================================
#
# IMPORTANT: OSMOSE utilise une architecture "1 instance = 1 client"
#
# Chaque client a sa propre instance d√©di√©e avec :
# - Sa propre base Neo4j
# - Sa propre base Qdrant
# - Ses propres fichiers de configuration
#
# Avantages :
# - Isolation totale des donn√©es (exigence enterprise/r√©glementaire)
# - Configuration sp√©cifique par client
# - Audit simplifi√©
# - Argument commercial : "Votre instance d√©di√©e"
#
# En cons√©quence :
# - Pas de multi-tenancy logique sur une m√™me instance
# - Le tenant_id reste "default" (ou nom client pour les logs)
# - Cette configuration s'applique √† TOUTE l'instance
#
# ===============================================================================
