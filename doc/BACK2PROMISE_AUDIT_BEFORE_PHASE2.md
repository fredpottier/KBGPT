# üìä Audit Complet - SAP Knowledge Base - √âtat Actuel (2025-10-10)

## üéØ Vue d'Ensemble du Projet

**Nom** : Back2Promise - SAP Knowledge Base
**Version** : 2.0.0 (Neo4j Native)
**Statut G√©n√©ral** : üü° En d√©veloppement actif
**Phases Compl√©t√©es** : Phase 0 (100%), Phase 1 Semaines 1-2 (40%)

---

## üèóÔ∏è Architecture Technique

### Stack Backend
- **Framework** : FastAPI 0.110+ (async/await natif)
- **Language** : Python 3.11+
- **Base de donn√©es relationnelle** : SQLite (metadata syst√®me)
- **Base de donn√©es graphe** : Neo4j 5.26.0 (Knowledge Graph natif)
- **Base vectorielle** : Qdrant 1.15.1 (embeddings)
- **Cache & Queue** : Redis 7.2 (RQ worker)
- **LLM** : Multi-provider (OpenAI, Anthropic, Ollama)

### Stack Frontend
- **Framework** : Next.js 14 (App Router)
- **Language** : TypeScript 5.0+
- **UI Library** : Chakra UI 2.8+
- **State Management** : React Context API
- **Authentification** : JWT (RS256, localStorage)

### Services d'Infrastructure (Docker Compose)

| Service | Image | Port | Statut | Fonction |
|---------|-------|------|--------|----------|
| **app** | sap-kb-app:latest | 8000 | ‚úÖ Running | FastAPI backend principal |
| **ingestion-worker** | sap-kb-worker:latest | 5679 | ‚úÖ Running | Worker async RQ (traitement docs) |
| **frontend** | sap-kb-frontend:latest | 3000 | ‚úÖ Running (healthy) | Interface Next.js moderne |
| **ui** | sap-kb-ui:latest | 8501 | ‚úÖ Running | Interface Streamlit legacy |
| **qdrant** | qdrant/qdrant:v1.15.1 | 6333 | ‚úÖ Running | Base vectorielle (2 collections) |
| **redis** | redis:7.2 | 6379 | ‚úÖ Running | Queue + cache |
| **ngrok** | ngrok/ngrok:latest | - | ‚úÖ Running | Tunneling pour webhooks |
| **neo4j** | neo4j:5.26.0 | 7474, 7687 | ‚úÖ Running (healthy) | Knowledge Graph (Graphiti) |
| **postgres-graphiti** | pgvector/pgvector:pg16 | 5433 | ‚úÖ Running (healthy) | PostgreSQL pour Graphiti |
| **graphiti** | zepai/graphiti:latest | 8300 | üü† Running (unhealthy) | API Graphiti (probl√®me connu) |

---

## üì° Backend API - Endpoints Complets

### 1. **Authentication** (`/api/auth`) - Phase 0 ‚úÖ

| Endpoint | M√©thode | Protection | Description |
|----------|---------|------------|-------------|
| `/api/auth/login` | POST | Public | Login avec email/password ‚Üí JWT tokens |
| `/api/auth/refresh` | POST | Public | Refresh access token avec refresh token |
| `/api/auth/register` | POST | Public | Cr√©ation compte utilisateur |
| `/api/auth/me` | GET | JWT Required | R√©cup√©ration utilisateur courant |

**Sch√©mas Pydantic** : `LoginRequest`, `TokenResponse`, `UserCreate`, `UserResponse`, `CurrentUser`

**Services** : `AuthService` (hash bcrypt, JWT RS256, cl√©s RSA 2048-bit)

**S√©curit√©** :
- ‚úÖ JWT RS256 avec cl√©s RSA asym√©triques
- ‚úÖ Access tokens (1h expiration)
- ‚úÖ Refresh tokens (7 jours)
- ‚úÖ Claims : user_id, email, role, tenant_id
- ‚úÖ RBAC : admin | editor | viewer

---

### 2. **Search** (`/search`) - Recherche Hybride

| Endpoint | M√©thode | Protection | Description |
|----------|---------|------------|-------------|
| `/search` | POST | Public | Recherche vectorielle multi-sources |

**Fonctionnalit√©s** :
- Recherche cascade : RFP Q/A (seuil 0.85) ‚Üí Knowbase g√©n√©ral (seuil 0.70)
- Collections Qdrant : `rfp_qa` (prioritaire), `knowbase`
- Enrichissement LLM avec contexte SAP
- Support filtres par tenant_id

---

### 3. **Facts** (`/api/facts`) - Knowledge Graph Phase 2

| Endpoint | M√©thode | Protection | Description |
|----------|---------|------------|-------------|
| `/api/facts` | POST | JWT + Tenant | Cr√©ation fact (status=proposed) |
| `/api/facts` | GET | JWT + Tenant | Liste facts avec filtres |
| `/api/facts/{id}` | GET | JWT + Tenant | R√©cup√©ration fact par ID |
| `/api/facts/{id}` | PUT | JWT + Tenant | Mise √† jour fact |
| `/api/facts/{id}` | DELETE | JWT + Admin | Suppression fact (admin only) |
| `/api/facts/{id}/approve` | POST | JWT + Admin | Approbation fact (status‚Üíapproved) |
| `/api/facts/{id}/reject` | POST | JWT + Admin | Rejet fact (status‚Üírejected) |
| `/api/facts/{id}/conflicts` | GET | JWT + Tenant | D√©tection conflits (CONTRADICTS, OVERRIDES) |
| `/api/facts/{id}/timeline` | GET | JWT + Tenant | Historique modifications fact |
| `/api/facts/stats` | GET | JWT + Tenant | Statistiques agr√©g√©es facts |

**Sch√©mas** : `FactCreate`, `FactUpdate`, `FactResponse`, `FactApproval`, `ConflictResponse`, `FactTimelineEntry`, `FactsStats`

**Service** : `FactsService` (Neo4j native)

**Governance** :
- Workflow approve/reject avec audit trail
- D√©tection conflits automatique
- Timeline historique valeurs
- Isolation multi-tenant stricte

---

### 4. **Entity Types** (`/api/entity-types`) - Phase 2 Registry

| Endpoint | M√©thode | Protection | Description |
|----------|---------|------------|-------------|
| `/api/entity-types` | GET | JWT + Tenant | Liste types d√©couverts (filtres status) |
| `/api/entity-types` | POST | JWT + Admin | Cr√©ation type manuel |
| `/api/entity-types/{type}` | GET | JWT + Tenant | D√©tail type avec compteurs |
| `/api/entity-types/{type}/approve` | POST | JWT + Admin | Approbation type (status‚Üíapproved) |
| `/api/entity-types/{type}/reject` | POST | JWT + Admin | Rejet type (status‚Üírejected + cascade delete) |
| `/api/entity-types/{type}/stats` | GET | JWT + Tenant | Statistiques type |

**Mod√®le SQLite** : `EntityTypeRegistry`
- Compteurs : `entity_count`, `pending_entity_count`
- Workflow : `pending` ‚Üí `approved` / `rejected`
- Audit : `approved_by`, `approved_at`, `rejection_reason`

**Service** : `EntityTypeRegistryService`

---

### 5. **Document Types** (`/api/document-types`) - Phase 6

| Endpoint | M√©thode | Protection | Description |
|----------|---------|------------|-------------|
| `/api/document-types` | GET | JWT + Tenant | Liste types documents |
| `/api/document-types` | POST | JWT + Admin | Cr√©ation type document |
| `/api/document-types/{id}` | GET | JWT + Tenant | D√©tail type |
| `/api/document-types/{id}` | PUT | JWT + Admin | Mise √† jour type |
| `/api/document-types/{id}` | DELETE | JWT + Admin | Suppression type |

**Mod√®les SQLite** : `DocumentType`, `DocumentTypeEntityType` (many-to-many)

**Fonctionnalit√©s** :
- Contexte prompt pour guider extraction LLM
- Association entity_types sugg√©r√©s
- Statistiques usage_count

**Service** : `DocumentTypeService`

---

### 6. **Ingestion** (`/api/ingest`) - Import Documents

| Endpoint | M√©thode | Protection | Description |
|----------|---------|------------|-------------|
| `/ingest/pdf` | POST | Public | Import PDF (MegaParse + OCR) |
| `/ingest/pptx` | POST | Public | Import PowerPoint (MegaParse) |
| `/ingest/excel-qa` | POST | Public | Import RFP Excel Q/A |
| `/api/ingest/rfp-excel/template` | GET | Public | T√©l√©charger template Excel RFP |

**Pipeline** :
1. Upload fichier ‚Üí `/data/docs_in/`
2. Job Redis RQ async
3. Parsing (PDF: Unstructured, PPTX: python-pptx)
4. Chunking + embeddings
5. Ingestion Qdrant
6. D√©placement vers `/data/docs_done/`

**Formats support√©s** : PDF, PPTX, DOCX, Excel (.xlsx)

---

### 7. **Imports** (`/api/imports`) - Historique & Monitoring

| Endpoint | M√©thode | Protection | Description |
|----------|---------|------------|-------------|
| `/api/imports/history` | GET | Public | Historique imports Redis |
| `/api/imports/active` | GET | Public | Jobs en cours (RQ) |
| `/api/imports/{uid}/delete` | DELETE | JWT + Admin | Suppression import + donn√©es Qdrant |
| `/api/imports/sync` | POST | JWT + Admin | Synchro Redis ‚Üî Qdrant |

**Storage** : Redis (hash `import:{uid}`)

**Service** : `ImportHistoryRedisService`, `ImportDeletionService`

---

### 8. **Status** (`/api/status`) - Health Checks

| Endpoint | M√©thode | Protection | Description |
|----------|---------|------------|-------------|
| `/api/status` | GET | Public | Health check multi-services |
| `/api/status/qdrant` | GET | Public | Statut Qdrant + collections |
| `/api/status/neo4j` | GET | Public | Statut Neo4j + compteurs |
| `/api/status/redis` | GET | Public | Statut Redis + queues |

**M√©triques retourn√©es** :
- Qdrant : collections count, vectors count, disk usage
- Neo4j : nodes count, relationships count, indexes
- Redis : queue sizes (default, failed, finished)

---

### 9. **Ontology** (`/api/ontology`) - Catalogues Entit√©s

| Endpoint | M√©thode | Protection | Description |
|----------|---------|------------|-------------|
| `/api/ontology/catalogues` | GET | Public | Liste catalogues disponibles |
| `/api/ontology/catalogues/{name}` | GET | Public | D√©tail catalogue avec entit√©s |
| `/api/ontology/entity-types` | GET | Public | Liste types d'entit√©s (multi-catalogues) |

**Catalogues disponibles** :
- `sap_modules.yaml` : Modules SAP (S/4HANA, ECC, BTP...)
- `sap_products.yaml` : Produits SAP
- `infrastructure.yaml` : Infra (Cloud, Database, Middleware)

---

### 10. **Jobs** (`/api/jobs`) - Monitoring RQ Worker

| Endpoint | M√©thode | Protection | Description |
|----------|---------|------------|-------------|
| `/api/jobs` | GET | Public | Liste jobs RQ (all/pending/finished/failed) |
| `/api/jobs/{job_id}` | GET | Public | D√©tail job avec progress |

**Queue Redis** : `default` (ingestion), `failed` (retry), `finished` (cleanup)

---

### 11. **Admin** (`/api/admin`) - Administration

| Endpoint | M√©thode | Protection | Description |
|----------|---------|------------|-------------|
| `/api/admin/purge` | POST | JWT + Admin | Purge compl√®te (Qdrant + Neo4j + Redis) |
| `/api/admin/health` | GET | JWT + Admin | Health check d√©taill√© syst√®me |

**Service** : `PurgeService` (purge s√©lective ou totale)

---

### 12. **SAP Solutions** (`/api/sap-solutions`) - Catalogue

| Endpoint | M√©thode | Protection | Description |
|----------|---------|------------|-------------|
| `/api/sap-solutions` | GET | Public | Liste solutions SAP (YAML config) |

**Config** : `config/sap_solutions.yaml` (50+ solutions SAP)

---

### 13. **Downloads** (`/api/downloads`) - T√©l√©chargement Documents Source

| Endpoint | M√©thode | Protection | Description |
|----------|---------|------------|-------------|
| `/api/downloads/{filename}` | GET | Public | T√©l√©charger document source original |

**Source** : `/data/docs_done/{filename}` (documents trait√©s)

---

### 14. **Token Analysis** (`/api/token-analysis`) - Co√ªts LLM

| Endpoint | M√©thode | Protection | Description |
|----------|---------|------------|-------------|
| `/api/token-analysis` | GET | Public | Statistiques tokens + co√ªts LLM |

**M√©triques** : total_tokens, input_tokens, output_tokens, estimated_cost

---

## üóÑÔ∏è Base de Donn√©es - Sch√©mas Complets

### SQLite - Metadata Syst√®me (`data/entity_types_registry.db`)

**Tables cr√©√©es** :

#### 1. `entity_types_registry` (Phase 2)
```sql
CREATE TABLE entity_types_registry (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    type_name VARCHAR(50) NOT NULL,           -- Ex: INFRASTRUCTURE, SOLUTION
    status VARCHAR(20) NOT NULL DEFAULT 'pending',  -- pending | approved | rejected
    first_seen TIMESTAMP NOT NULL,
    discovered_by VARCHAR(20) DEFAULT 'llm',  -- llm | admin | system
    entity_count INTEGER DEFAULT 0,
    pending_entity_count INTEGER DEFAULT 0,
    approved_by VARCHAR(100),
    approved_at TIMESTAMP,
    rejected_by VARCHAR(100),
    rejected_at TIMESTAMP,
    rejection_reason TEXT,
    tenant_id VARCHAR(50) DEFAULT 'default',
    description TEXT,
    normalization_status VARCHAR(20),         -- generating | pending_review | NULL
    normalization_job_id VARCHAR(50),
    normalization_started_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(type_name, tenant_id)
);
CREATE INDEX ix_type_status_tenant ON entity_types_registry(status, tenant_id);
```

#### 2. `document_types` (Phase 6)
```sql
CREATE TABLE document_types (
    id VARCHAR(36) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,               -- Ex: Technical Documentation
    slug VARCHAR(50) NOT NULL UNIQUE,         -- Ex: technical
    description TEXT,
    context_prompt TEXT,                      -- Prompt contextuel pour LLM
    prompt_config TEXT,                       -- JSON config
    usage_count INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    tenant_id VARCHAR(50) DEFAULT 'default',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(slug, tenant_id)
);
```

#### 3. `document_type_entity_types` (Phase 6 - Many-to-Many)
```sql
CREATE TABLE document_type_entity_types (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    document_type_id VARCHAR(36) NOT NULL,
    entity_type_name VARCHAR(50) NOT NULL,    -- SOLUTION, PRODUCT, etc.
    source VARCHAR(20) DEFAULT 'manual',      -- manual | llm_discovered | template
    confidence FLOAT,                         -- 0.0-1.0 si d√©couvert par LLM
    validated_by VARCHAR(100),
    validated_at TIMESTAMP,
    examples TEXT,                            -- JSON array exemples
    tenant_id VARCHAR(50) DEFAULT 'default',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(document_type_id, entity_type_name),
    FOREIGN KEY(document_type_id) REFERENCES document_types(id) ON DELETE CASCADE
);
```

#### 4. `users` (Phase 0 - Authentication)
```sql
CREATE TABLE users (
    id VARCHAR(36) PRIMARY KEY,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,      -- bcrypt hash
    full_name VARCHAR(100),
    role VARCHAR(20) NOT NULL DEFAULT 'viewer',  -- admin | editor | viewer
    tenant_id VARCHAR(50) DEFAULT 'default',
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP
);
CREATE INDEX ix_user_email ON users(email);
CREATE INDEX ix_user_tenant_role ON users(tenant_id, role);
```

#### 5. `audit_log` (Phase 0 - Audit Trail)
```sql
CREATE TABLE audit_log (
    id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36),                      -- FK vers users
    user_email VARCHAR(255) NOT NULL,
    action VARCHAR(50) NOT NULL,              -- CREATE | UPDATE | DELETE | APPROVE | REJECT
    resource_type VARCHAR(50) NOT NULL,       -- entity | fact | entity_type | document_type
    resource_id VARCHAR(255),
    tenant_id VARCHAR(50) NOT NULL,
    details TEXT,                             -- JSON avec before/after
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE SET NULL
);
CREATE INDEX ix_audit_timestamp ON audit_log(timestamp);
CREATE INDEX ix_audit_user_action ON audit_log(user_id, action);
CREATE INDEX ix_audit_resource ON audit_log(resource_type, resource_id);
```

**Total Tables SQLite** : 5 tables principales + indexes

---

### Neo4j - Knowledge Graph (`bolt://localhost:7687`)

**Sch√©mas cr√©√©s** :

#### Phase 1 - Document Backbone (Semaines 1-2) ‚úÖ

**Nodes** :

1. **`:Document`** - Documents source
```cypher
(:Document {
    document_id: STRING (UUID),              // UNIQUE CONSTRAINT
    title: STRING,
    source_path: STRING,                     // UNIQUE CONSTRAINT
    document_type: STRING,                   // "Technical Presentation", "Proposal"...
    description: STRING,
    status: STRING,                          // "active", "archived"
    metadata: STRING (JSON),
    tenant_id: STRING,
    created_at: DATETIME,
    updated_at: DATETIME
})
```

2. **`:DocumentVersion`** - Versions documentaires
```cypher
(:DocumentVersion {
    version_id: STRING (UUID),               // UNIQUE CONSTRAINT
    document_id: STRING,
    version_label: STRING,                   // "v1.0", "v2.1"
    effective_date: DATETIME,
    checksum: STRING (SHA256),               // UNIQUE CONSTRAINT (anti-duplicatas)
    file_size: INTEGER,
    page_count: INTEGER,
    author_name: STRING,
    author_email: STRING,
    reviewer_name: STRING,
    is_latest: BOOLEAN,
    metadata: STRING (JSON),
    created_at: DATETIME,
    ingested_at: DATETIME
})
```

**Relationships** :

1. `(:Document)-[:HAS_VERSION]->(:DocumentVersion)` - Lien document ‚Üí version
2. `(:DocumentVersion)-[:SUPERSEDES]->(:DocumentVersion)` - Lineage versions (v2 supersedes v1)
3. `(:DocumentVersion)-[:AUTHORED_BY]->(:Person)` - Authorship
4. `(:DocumentVersion)-[:REVIEWED_BY]->(:Person)` - Review
5. `(:Episode)-[:FROM_DOCUMENT]->(:DocumentVersion)` - Provenance episode ‚Üí version

**Contraintes Neo4j** :
```cypher
CREATE CONSTRAINT doc_id_unique IF NOT EXISTS
FOR (d:Document) REQUIRE d.document_id IS UNIQUE;

CREATE CONSTRAINT doc_version_id_unique IF NOT EXISTS
FOR (v:DocumentVersion) REQUIRE v.version_id IS UNIQUE;

CREATE CONSTRAINT doc_version_checksum_unique IF NOT EXISTS
FOR (v:DocumentVersion) REQUIRE v.checksum IS UNIQUE;

CREATE CONSTRAINT doc_source_path_unique IF NOT EXISTS
FOR (d:Document) REQUIRE d.source_path IS UNIQUE;
```

**Index Neo4j** (7 index cr√©√©s) :
```cypher
CREATE INDEX doc_source_path_idx IF NOT EXISTS
FOR (d:Document) ON (d.source_path);

CREATE INDEX doc_tenant_idx IF NOT EXISTS
FOR (d:Document) ON (d.tenant_id);

CREATE INDEX doc_version_label_idx IF NOT EXISTS
FOR (v:DocumentVersion) ON (v.version_label);

CREATE INDEX doc_version_effective_date_idx IF NOT EXISTS
FOR (v:DocumentVersion) ON (v.effective_date);

CREATE INDEX doc_version_checksum_idx IF NOT EXISTS
FOR (v:DocumentVersion) ON (v.checksum);

CREATE INDEX doc_version_is_latest_idx IF NOT EXISTS
FOR (v:DocumentVersion) ON (v.is_latest);

CREATE INDEX doc_version_composite_idx IF NOT EXISTS
FOR (v:DocumentVersion) ON (v.document_id, v.effective_date);
```

**Services Phase 1** :
- ‚úÖ `DocumentSchema` - Cr√©ation sch√©ma Neo4j
- ‚úÖ `DocumentRegistryService` - CRUD documents/versions
- ‚úÖ `VersionResolutionService` - R√©solution versions (latest, effective_at, lineage)

---

#### Phase 2 - Facts Knowledge Graph (D√©j√† existant)

**Nodes** : `:Fact`, `:Entity`, `:Episode`

**Service** : `FactsService` (API REST compl√®te)

---

### Qdrant - Collections Vectorielles

| Collection | Dimensions | Vectors | Description |
|------------|------------|---------|-------------|
| `rfp_qa` | 1536 (OpenAI) | Variable | Questions/R√©ponses RFP prioritaires |
| `knowbase` | 1536 (OpenAI) | Variable | Base de connaissances g√©n√©rale |

**Metadata stock√©s** :
- `source_document` : Nom fichier source
- `import_uid` : UID import Redis
- `tenant_id` : Isolation multi-tenant
- `chunk_index` : Index chunk dans document
- `page_number` : Num√©ro page source
- `timestamp` : Date ingestion

---

## üñ•Ô∏è Frontend - Pages Compl√®tes

### Architecture Next.js 14

**Router** : App Router (file-based routing)
**Layout** : `MainLayout` avec TopNavigation + ContextualSidebar
**Authentification** : `AuthContext` (React Context + JWT localStorage)

---

### Pages Impl√©ment√©es (18 pages)

#### 1. Authentification

| Page | Route | Protection | Description |
|------|-------|------------|-------------|
| Login | `/login` | Public | Authentification JWT (email/password) |
| Register | `/register` | Public | Cr√©ation compte (full_name, email, password, role) |

**Features** :
- Validation mot de passe (8 chars min)
- Redirection `?redirect=/admin` apr√®s login
- Show/hide password toggle
- S√©lection r√¥le (admin/editor/viewer)

---

#### 2. Chat & Recherche

| Page | Route | Protection | Description |
|------|-------|------------|-------------|
| Home | `/` | Public | Redirection vers `/chat` |
| Chat | `/chat` | Public | Interface recherche hybride vectorielle |

**Features** :
- Recherche full-text + vectorielle
- Affichage sources avec scores
- Historique conversations
- Export r√©sultats

---

#### 3. Documents

| Page | Route | Protection | Description |
|------|-------|------------|-------------|
| Documents List | `/documents` | Public | Liste documents ing√©r√©s |
| Document Detail | `/documents/[id]` | Public | D√©tail document avec chunks |
| Document Upload | `/documents/upload` | JWT + Editor | Upload documents (PDF, PPTX) |
| Document Import | `/documents/import` | JWT + Editor | Import documents avec config |
| Import Status | `/documents/status` | Public | Historique imports + monitoring jobs |
| RFP Excel | `/rfp-excel` | JWT + Editor | Import Q/A Excel RFP |

**Features** :
- Drag & drop upload
- Monitoring temps r√©el (RQ jobs)
- Progress bars ingestion
- Suppression imports avec cascade Qdrant
- Export template Excel RFP

---

#### 4. Administration

| Page | Route | Protection | Description |
|------|-------|------------|-------------|
| Admin Dashboard | `/admin` | JWT + Admin | Dashboard admin avec stats |
| Entity Types | `/admin/dynamic-types` | JWT + Admin | Liste entity types (approve/reject workflow) |
| Entity Type Detail | `/admin/dynamic-types/[typeName]` | JWT + Admin | D√©tail type avec entit√©s associ√©es |
| Document Types List | `/admin/document-types` | JWT + Admin | Liste types documents |
| Document Type Create | `/admin/document-types/new` | JWT + Admin | Cr√©ation type document |
| Document Type Edit | `/admin/document-types/[id]` | JWT + Admin | √âdition type document |
| Settings | `/admin/settings` | JWT + Admin | Param√®tres syst√®me |

**Features** :
- Approve/Reject entity types d√©couverts
- Association entity_types ‚Üí document_types
- Statistiques temps r√©el (compteurs Neo4j)
- Purge donn√©es (Qdrant + Neo4j + Redis)

---

### Composants Partag√©s

**Layout** :
- `MainLayout` : Layout principal avec navigation
- `TopNavigation` : Menu horizontal (Chat, Documents, Admin)
- `ContextualSidebar` : Menu lat√©ral contextuel (documents, admin)

**Auth** :
- `ProtectedRoute` : Wrapper protection par JWT
- `AuthContext` : Context global auth (user, login, logout, hasRole)

**UI** :
- Chakra UI components (Button, Modal, Table, Badge...)
- Custom colors : `brand.500` (bleu SAP)
- Responsive design (mobile-first)

---

## üîê S√©curit√© - Phase 0 Compl√©t√©e (100%)

### Authentification JWT RS256 ‚úÖ

**Implementation** :
- ‚úÖ Cl√©s RSA 2048-bit g√©n√©r√©es (`config/keys/jwt_private.pem`, `jwt_public.pem`)
- ‚úÖ Access token : 1h expiration
- ‚úÖ Refresh token : 7 jours expiration
- ‚úÖ Claims JWT : `user_id`, `email`, `role`, `tenant_id`
- ‚úÖ Hash bcrypt pour passwords (12 rounds)

**Endpoints Auth** :
- ‚úÖ `POST /api/auth/login` - Login
- ‚úÖ `POST /api/auth/refresh` - Refresh token
- ‚úÖ `GET /api/auth/me` - Current user
- ‚úÖ `POST /api/auth/register` - Register

**Dependencies FastAPI** :
- ‚úÖ `get_current_user()` - Extraction user depuis JWT
- ‚úÖ `require_admin()` - Protection admin only
- ‚úÖ `require_editor()` - Protection editor+
- ‚úÖ `get_tenant_id()` - Extraction tenant_id depuis JWT (pas query param)

**Tests** :
- ‚úÖ 13 tests unitaires `AuthService`
- ‚úÖ 10 tests dependencies FastAPI
- ‚úÖ 14 tests E2E endpoints auth
- **Total : 37 tests authentication pass√©s** ‚úÖ

---

### RBAC (Role-Based Access Control) ‚úÖ

**R√¥les d√©finis** :
- **admin** : Full access (CRUD, approve/reject, purge)
- **editor** : Create/update entities/facts (pas delete)
- **viewer** : Read-only

**Hi√©rarchie** : `admin > editor > viewer`

**Protection endpoints** :
- ‚úÖ Facts API : Tenant isolation + RBAC
- ‚úÖ Entity Types : Admin approve/reject only
- ‚úÖ Document Types : Admin CRUD only
- ‚úÖ Admin purge : Admin only

---

### Rate Limiting ‚úÖ

**Implementation** : SlowAPI
**Limites** : 100 requ√™tes/minute par IP
**Erreur** : HTTP 429 Too Many Requests

---

### Audit Trail ‚úÖ

**Table** : `audit_log` (SQLite)
**Actions logg√©es** : CREATE, UPDATE, DELETE, APPROVE, REJECT
**M√©tadonn√©es** :
- user_id, user_email
- action, resource_type, resource_id
- tenant_id
- details (JSON before/after)
- timestamp

**Service** : `AuditService` (non encore impl√©ment√© dans tous endpoints)

---

### Multi-Tenancy ‚úÖ

**Isolation** :
- ‚úÖ `tenant_id` extrait depuis JWT (pas query param)
- ‚úÖ Tous les endpoints Facts isol√©s par tenant
- ‚úÖ Index composite `(tenant_id, type_name)` dans SQLite
- ‚úÖ Queries Neo4j filtr√©es par `tenant_id`

---

## üìä Phases & Progression

### ‚úÖ Phase 0 : Security Hardening - **100% COMPL√âT√âE**

**Dur√©e** : 1 journ√©e (2025-10-09)
**Effort** : ~20h (acc√©l√©r√©e vs 160h pr√©vues)

**R√©alisations** :
- ‚úÖ JWT RS256 Authentication compl√®te
- ‚úÖ RBAC (admin/editor/viewer)
- ‚úÖ Dependencies FastAPI (get_current_user, require_admin...)
- ‚úÖ Mod√®les SQLite (User, AuditLog)
- ‚úÖ 37 tests authentication (tous pass√©s)
- ‚úÖ Rate limiting SlowAPI (100 req/min)
- ‚úÖ Script cr√©ation admin par d√©faut

**Score s√©curit√©** : 8.5/10 (target atteint)

---

### üü° Phase 1 : Document Backbone - **40% COMPL√âT√âE** (Semaines 1-2)

**Dur√©e pr√©vue** : 5 semaines
**Statut** : üü° En cours (d√©marr√© le 2025-10-10)
**Effort estim√©** : 200 heures

**R√©alisations (Semaines 1-2)** :

#### ‚úÖ Semaine 1 : Sch√©ma Neo4j (100%)
- ‚úÖ Nodes `:Document` et `:DocumentVersion`
- ‚úÖ 4 contraintes unicit√© (document_id, version_id, checksum, source_path)
- ‚úÖ 7 index performance (source_path, tenant_id, version_label, effective_date, checksum, is_latest, composite)
- ‚úÖ 5 relations (HAS_VERSION, SUPERSEDES, AUTHORED_BY, REVIEWED_BY, FROM_DOCUMENT)
- ‚úÖ Script migration `document_schema.py`

#### ‚úÖ Semaine 2 : Services Backend (100%)
- ‚úÖ `DocumentRegistryService` - CRUD documents/versions
  - `create_document()` : Cr√©ation document + version initiale
  - `create_version()` : Ajout nouvelle version
  - `get_document_by_id()` : R√©cup√©ration document avec versions
  - `get_latest_version()` : Version la plus r√©cente
  - `detect_duplicate()` : D√©tection par checksum SHA256
  - `list_documents()` : Liste avec filtres (status, type, pagination)
- ‚úÖ `VersionResolutionService` - R√©solution versions
  - `resolve_latest()` : R√©solution version active
  - `resolve_effective_at(date)` : Point-in-time query
  - `get_version_lineage()` : Graphe succession versions
  - `compare_versions()` : Diff metadata entre versions
  - `check_obsolescence()` : D√©tection versions obsol√®tes
- ‚úÖ Schemas Pydantic complets
  - `DocumentCreate`, `DocumentUpdate`, `DocumentResponse`
  - `DocumentVersionCreate`, `DocumentVersionResponse`
  - `DocumentLineage`, `VersionComparison`
  - Enums : `DocumentStatus`, `DocumentType`

**Fichiers cr√©√©s (Phase 1)** :
```
src/knowbase/ontology/document_schema.py
src/knowbase/api/schemas/documents.py
src/knowbase/api/services/document_registry_service.py
src/knowbase/api/services/version_resolution_service.py
```

---

#### ‚è∏Ô∏è Semaine 3 : Ingestion Updates (0% - EN ATTENTE)

**T√¢ches pr√©vues** :
- Parser metadata documents (PPTX metadata, creator, date publication)
- Calcul checksum SHA256 automatique
- D√©tection duplicatas avant ingestion
- Link Episode ‚Üí DocumentVersion (relation PRODUCES)

---

#### ‚è∏Ô∏è Semaine 4 : APIs REST (0% - EN ATTENTE)

**Endpoints √† cr√©er** :
- `GET /api/documents` - Liste documents
- `GET /api/documents/{id}/versions` - Historique versions
- `GET /api/documents/{id}/lineage` - Graphe modifications
- `POST /api/documents/{id}/versions` - Upload nouvelle version

---

#### ‚è∏Ô∏è Semaine 5 : UI Admin (0% - EN ATTENTE)

**Pages √† cr√©er** :
- `/admin/documents/[id]/timeline` - Timeline view versions
- `/admin/documents/[id]/compare` - Comparaison versions
- Badges "Obsol√®te" sur versions p√©rim√©es
- Change log visualisation

---

### M√©triques Phase 1

| M√©trique | Actuel | Target | Statut |
|----------|--------|--------|--------|
| **Statut Phase** | üü° EN COURS | COMPL√âT√â | üü° |
| **Semaines √©coul√©es** | 1/5 | 5/5 | üü° |
| **T√¢ches compl√©t√©es** | 2/5 (40%) | 5/5 | üü° |
| **Couverture tests** | 0% | 85%+ | ‚è∏Ô∏è |
| **Score conformit√©** | 40% | 100% | üü° |
| **% documents avec versioning** | 0% | 100% | ‚è∏Ô∏è Pipeline non int√©gr√© |
| **Performance latest version** | ~2ms (estim√©) | < 500ms | ‚úÖ Index optimaux |
| **D√©tection duplicatas** | 0% | 100% | ‚è∏Ô∏è Checksum non calcul√© |

---

## üìÅ Structure Fichiers Projet

```
SAP_KB/
‚îú‚îÄ‚îÄ src/knowbase/                     # Code Python principal
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routers/                  # 15 routers FastAPI
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.py               # Authentication JWT
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ facts.py              # Knowledge Graph Facts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entity_types.py       # Entity Types Registry
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ document_types.py     # Document Types Management
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entities.py           # Entities dynamiques
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ontology.py           # Catalogues ontologies
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ search.py             # Recherche hybride
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ingest.py             # Ingestion documents
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ imports.py            # Historique imports
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ status.py             # Health checks
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ jobs.py               # Monitoring RQ
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin.py              # Admin purge
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ downloads.py          # T√©l√©chargement docs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ token_analysis.py     # Analyse co√ªts LLM
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sap_solutions.py      # Catalogue SAP
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/                 # 22 services m√©tier
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth_service.py       # JWT + bcrypt
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ audit_service.py      # Audit trail
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ document_registry_service.py  # CRUD documents Phase 1
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ version_resolution_service.py # Versioning Phase 1
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ facts_service.py      # Facts Neo4j
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entity_type_registry_service.py  # Registry types
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ document_type_service.py  # Document types
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ knowledge_graph_service.py  # Neo4j queries
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ import_history_redis.py  # Historique Redis
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ import_deletion.py    # Suppression imports
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ purge_service.py      # Purge donn√©es
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ search.py             # Recherche Qdrant
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ synthesis.py          # Synth√®se LLM
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ... (9 autres services)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schemas/                  # Mod√®les Pydantic v2
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.py               # Schemas auth JWT
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ documents.py          # Schemas Phase 1 Document Backbone
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ facts.py              # Schemas Facts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dependencies.py           # Dependencies FastAPI (get_current_user, etc.)
‚îÇ   ‚îú‚îÄ‚îÄ ingestion/                    # Pipelines traitement
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ parsers/                  # Parsers documents
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pdf_parser.py         # PDF avec OCR
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pptx_parser.py        # PowerPoint
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ excel_qa_parser.py    # RFP Excel
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pipelines/                # Pipelines ingestion
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ queue.py                  # RQ worker
‚îÇ   ‚îú‚îÄ‚îÄ ontology/                     # Sch√©mas Neo4j
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ document_schema.py        # Phase 1 Document Backbone
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ neo4j_client.py           # Client Neo4j
‚îÇ   ‚îú‚îÄ‚îÄ common/                       # Clients externes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ qdrant_client.py          # Client Qdrant
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ llm_router.py             # Multi-provider LLM
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ openai_client.py          # Client OpenAI
‚îÇ   ‚îú‚îÄ‚îÄ db/                           # Database SQLite
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models.py                 # Mod√®les SQLAlchemy (5 tables)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.py                   # Base SQLAlchemy
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ __init__.py               # init_db()
‚îÇ   ‚îî‚îÄ‚îÄ config/                       # Configuration
‚îÇ       ‚îî‚îÄ‚îÄ settings.py               # Settings Pydantic
‚îÇ
‚îú‚îÄ‚îÄ frontend/src/                     # Interface Next.js TypeScript
‚îÇ   ‚îú‚îÄ‚îÄ app/                          # App Router Next.js 14
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                  # Home (redirect /chat)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login/page.tsx            # Login JWT
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ register/page.tsx         # Register
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat/page.tsx             # Chat recherche
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ documents/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx              # Liste documents
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ [id]/page.tsx         # D√©tail document
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ upload/page.tsx       # Upload documents
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ import/page.tsx       # Import config
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ status/page.tsx       # Historique imports
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rfp/page.tsx          # (legacy)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rfp-excel/page.tsx        # Import RFP Excel
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ admin/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ page.tsx              # Admin dashboard
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ dynamic-types/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx          # Liste entity types
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ [typeName]/page.tsx  # D√©tail type
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ document-types/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx          # Liste document types
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ new/page.tsx      # Cr√©ation type
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ [id]/page.tsx     # √âdition type
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ settings/page.tsx     # Param√®tres
‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MainLayout.tsx        # Layout principal
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TopNavigation.tsx     # Menu horizontal + user menu
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ContextualSidebar.tsx # Menu lat√©ral
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ProtectedRoute.tsx    # Protection JWT
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ... (composants UI)
‚îÇ   ‚îú‚îÄ‚îÄ contexts/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AuthContext.tsx           # Context global auth
‚îÇ   ‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api.ts                    # API client (axios + interceptor JWT)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth.ts                   # Auth service
‚îÇ   ‚îî‚îÄ‚îÄ styles/
‚îÇ       ‚îî‚îÄ‚îÄ theme.ts                  # Chakra UI theme
‚îÇ
‚îú‚îÄ‚îÄ config/                           # Configuration YAML
‚îÇ   ‚îú‚îÄ‚îÄ llm_models.yaml               # Configuration LLM multi-provider
‚îÇ   ‚îú‚îÄ‚îÄ prompts.yaml                  # Prompts configurables
‚îÇ   ‚îú‚îÄ‚îÄ sap_solutions.yaml            # Catalogue SAP (50+ solutions)
‚îÇ   ‚îú‚îÄ‚îÄ keys/                         # Cl√©s RSA JWT
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ jwt_private.pem           # Cl√© priv√©e RSA 2048-bit
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ jwt_public.pem            # Cl√© publique
‚îÇ   ‚îî‚îÄ‚îÄ ontologies/                   # Catalogues YAML
‚îÇ       ‚îú‚îÄ‚îÄ sap_modules.yaml
‚îÇ       ‚îú‚îÄ‚îÄ sap_products.yaml
‚îÇ       ‚îî‚îÄ‚îÄ infrastructure.yaml
‚îÇ
‚îú‚îÄ‚îÄ data/                             # Donn√©es runtime
‚îÇ   ‚îú‚îÄ‚îÄ docs_in/                      # Documents √† traiter
‚îÇ   ‚îú‚îÄ‚îÄ docs_done/                    # Documents trait√©s
‚îÇ   ‚îú‚îÄ‚îÄ public/                       # Assets (slides, thumbnails)
‚îÇ   ‚îú‚îÄ‚îÄ models/                       # Mod√®les Hugging Face cache
‚îÇ   ‚îú‚îÄ‚îÄ logs/                         # Logs application
‚îÇ   ‚îî‚îÄ‚îÄ entity_types_registry.db      # SQLite database
‚îÇ
‚îú‚îÄ‚îÄ doc/                              # Documentation
‚îÇ   ‚îú‚îÄ‚îÄ BACK2PROMISE_MASTER_ROADMAP.md  # Roadmap 6 phases
‚îÇ   ‚îú‚îÄ‚îÄ PHASE_0_SECURITY_TRACKING.md    # Phase 0 compl√©t√©e
‚îÇ   ‚îú‚îÄ‚îÄ PHASE1_DOCUMENT_BACKBONE_TRACKING.md  # Phase 1 en cours
‚îÇ   ‚îú‚îÄ‚îÄ ENDPOINTS_PROTECTION_CHECKLIST.md  # Checklist migration JWT
‚îÇ   ‚îú‚îÄ‚îÄ AUTH_API_MIGRATION_REPORT.md    # Rapport migration auth frontend
‚îÇ   ‚îî‚îÄ‚îÄ ... (10+ fichiers documentation)
‚îÇ
‚îú‚îÄ‚îÄ tests/                            # Tests unitaires + E2E
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_auth_service.py      # 13 tests AuthService
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_auth_endpoints.py    # 14 tests E2E auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_auth_dependencies.py # 10 tests dependencies
‚îÇ   ‚îî‚îÄ‚îÄ ... (autres tests)
‚îÇ
‚îú‚îÄ‚îÄ docker-compose.yml                # Orchestration 11 services
‚îú‚îÄ‚îÄ .env                              # Variables d'environnement
‚îú‚îÄ‚îÄ README.md                         # Documentation principale
‚îî‚îÄ‚îÄ CLAUDE.md                         # Instructions Claude Code

**Total** :
- ~100 fichiers Python backend
- ~50 fichiers TypeScript frontend
- ~150 fichiers au total (hors node_modules, venv)
```

---

## üìà Statistiques & M√©triques

### Backend API
- **Routers** : 15 routers FastAPI
- **Endpoints** : ~60 endpoints REST
- **Services** : 22 services m√©tier
- **Mod√®les SQLite** : 5 tables
- **Schemas Pydantic** : 30+ schemas
- **Tests** : 37 tests auth (Phase 0), 0 tests Phase 1 (√† venir)

### Frontend
- **Pages** : 18 pages Next.js
- **Composants** : 20+ composants React
- **Contexts** : 1 context (Auth)
- **API Client** : axios + interceptor JWT

### Infrastructure
- **Services Docker** : 11 containers
- **Bases de donn√©es** : 3 (SQLite, Neo4j, Qdrant)
- **Cache/Queue** : Redis
- **Status** : Tous services ‚úÖ Running (1 unhealthy: graphiti - probl√®me connu)

### Code
- **Lignes Python** : ~15,000 lignes (estimation)
- **Lignes TypeScript** : ~5,000 lignes (estimation)
- **Configuration YAML** : 5 fichiers
- **Documentation** : 15+ fichiers Markdown

---

## üöÄ URLs d'Acc√®s

| Service | URL | Description |
|---------|-----|-------------|
| **Frontend moderne** | http://localhost:3000 | Interface Next.js principale |
| **API Documentation** | http://localhost:8000/docs | Swagger UI FastAPI |
| **API Backend** | http://localhost:8000 | API REST FastAPI |
| **Interface legacy** | http://localhost:8501 | Streamlit (√† d√©pr√©cier) |
| **Qdrant Dashboard** | http://localhost:6333/dashboard | Interface Qdrant |
| **Neo4j Browser** | http://localhost:7474 | Interface Neo4j |
| **Adminer (Graphiti)** | http://localhost:8080 | Interface PostgreSQL |
| **Graphiti API** | http://localhost:8300 | API Graphiti (unhealthy) |

---

## ‚ö†Ô∏è Probl√®mes Connus & Limitations

### 1. Graphiti Service Unhealthy üü†
**Statut** : Container running mais unhealthy
**Impact** : API Graphiti (port 8300) ne r√©pond pas correctement aux health checks
**Mitigation** : Service non critique pour Phase 1, investigation n√©cessaire si requis

### 2. Phase 1 Pipeline Non Int√©gr√© ‚è∏Ô∏è
**Statut** : Services cr√©√©s mais pas int√©gr√©s au pipeline ingestion
**Impact** : Documents ing√©r√©s n'ont pas de versioning/provenance
**Prochaine √©tape** : Semaine 3 - Int√©gration pipeline

### 3. Tests Phase 1 Non Cr√©√©s ‚è∏Ô∏è
**Statut** : 0% coverage tests Phase 1
**Impact** : Services DocumentRegistry/VersionResolution non test√©s
**Target** : 85%+ coverage (pr√©vue Semaine 3)

### 4. Endpoints API Phase 1 Non Expos√©s ‚è∏Ô∏è
**Statut** : Pas de router `/api/documents` encore
**Impact** : Services uniquement utilisables en interne
**Prochaine √©tape** : Semaine 4 - Cr√©ation router documents

---

## üìù Prochaines Actions Recommand√©es

### Priorit√© 1 - Finaliser Phase 1 (Semaine 3) üéØ

**Effort estim√©** : 5-7 jours

1. **Modifier `megaparse_parser.py`** pour extraire :
   - Version (PPTX metadata `dc:version` ou filename pattern)
   - Creator (`dc:creator`)
   - Date publication (`dcterms:created`)
   - Reviewers/Approvers (custom properties si disponibles)

2. **Impl√©menter fonction `calculate_checksum(file_path)`** :
   - SHA256 hash du fichier
   - Appel avant ingestion
   - Stockage dans `DocumentVersion.checksum`

3. **Int√©grer DocumentRegistry dans pipeline ingestion** :
   ```python
   doc_service = DocumentRegistryService(neo4j_client)

   # V√©rifier duplicata
   existing = doc_service.get_version_by_checksum(checksum)
   if existing:
       logger.info(f"Document duplicate d√©tect√©: {filename}")
       return  # Skip ingestion

   # Cr√©er document + version
   doc = doc_service.create_document(...)
   ```

4. **Lier Episode ‚Üí DocumentVersion** :
   - Ajouter `document_id` et `document_version_id` dans Episode metadata
   - Cr√©er relation `(:Episode)-[:PRODUCES]->(:DocumentVersion)`

5. **Cr√©er tests unitaires** :
   - 20+ tests `DocumentRegistryService`
   - 15+ tests `VersionResolutionService`
   - Target : 85%+ coverage

---

### Priorit√© 2 - Cr√©er APIs REST Documents (Semaine 4) üì°

**Effort estim√©** : 3-5 jours

1. Cr√©er router `src/knowbase/api/routers/documents.py`
2. Impl√©menter endpoints :
   - `GET /api/documents` - Liste documents (pagination, filtres)
   - `GET /api/documents/{id}/versions` - Historique versions
   - `GET /api/documents/{id}/lineage` - Graphe modifications
   - `POST /api/documents/{id}/versions` - Upload nouvelle version

3. Protection JWT + RBAC :
   - GET : `Depends(get_current_user)` (tous roles)
   - POST : `Depends(require_editor)` (editor + admin)

---

### Priorit√© 3 - UI Admin Documents (Semaine 5) üñ•Ô∏è

**Effort estim√©** : 5-7 jours

1. Cr√©er pages Next.js :
   - `/admin/documents/[id]/timeline` - Timeline view versions
   - `/admin/documents/[id]/compare` - Comparaison versions

2. Visualisations :
   - Chakra Timeline component
   - Diff metadata side-by-side
   - Badges "Obsol√®te" sur versions p√©rim√©es

---

## üéØ R√©sum√© Ex√©cutif

### √âtat Actuel du Projet (2025-10-10)

‚úÖ **Phase 0 (Security Hardening)** : **100% COMPL√âT√âE**
- JWT RS256 Authentication fonctionnelle
- RBAC (admin/editor/viewer) impl√©ment√©
- 37 tests authentication tous pass√©s
- Score s√©curit√© : 8.5/10 (target atteint)

üü° **Phase 1 (Document Backbone)** : **40% COMPL√âT√âE** (Semaines 1-2/5)
- Sch√©ma Neo4j complet (4 contraintes + 7 index)
- Services backend cr√©√©s (DocumentRegistry, VersionResolution)
- **‚è∏Ô∏è En attente** : Int√©gration pipeline (Semaines 3-5)

üöÄ **Infrastructure** : **11 services Docker running**
- Backend FastAPI + Worker RQ op√©rationnels
- Frontend Next.js fonctionnel avec auth JWT
- Qdrant + Neo4j + Redis stables

üì° **API** : **~60 endpoints REST fonctionnels**
- 15 routers FastAPI
- 22 services m√©tier
- Authentication compl√®te (login, register, refresh, me)
- Facts, Entity Types, Document Types op√©rationnels

üñ•Ô∏è **Frontend** : **18 pages Next.js impl√©ment√©es**
- Authentification JWT compl√®te (login, register, user menu)
- Admin dashboard avec entity types workflow
- Import documents (PDF, PPTX, Excel RFP)
- Monitoring jobs temps r√©el

üóÑÔ∏è **Bases de donn√©es** :
- **SQLite** : 5 tables (users, audit_log, entity_types_registry, document_types...)
- **Neo4j** : Sch√©ma Document Backbone (4 contraintes + 7 index) + Facts existants
- **Qdrant** : 2 collections (rfp_qa, knowbase)

---

### M√©triques Globales

| Cat√©gorie | M√©trique | Valeur | Statut |
|-----------|----------|--------|--------|
| **Backend** | Routers | 15 | ‚úÖ |
| **Backend** | Endpoints | ~60 | ‚úÖ |
| **Backend** | Services | 22 | ‚úÖ |
| **Backend** | Tests | 37 (Phase 0) | ‚úÖ |
| **Frontend** | Pages | 18 | ‚úÖ |
| **Frontend** | Composants | 20+ | ‚úÖ |
| **Database** | Tables SQLite | 5 | ‚úÖ |
| **Database** | Nodes Neo4j | 2 (Document, DocumentVersion) | ‚úÖ |
| **Database** | Collections Qdrant | 2 (rfp_qa, knowbase) | ‚úÖ |
| **S√©curit√©** | Score | 8.5/10 | ‚úÖ |
| **S√©curit√©** | JWT Tests | 37/37 pass√©s | ‚úÖ |
| **Phase 0** | Progression | 100% | ‚úÖ |
| **Phase 1** | Progression | 40% (Semaines 1-2) | üü° |

---

**Prochaine √©tape imm√©diate** :
üéØ **D√©marrer Phase 1 Semaine 3** - Int√©gration pipeline ingestion avec extraction metadata, calcul checksum, et d√©tection duplicatas (5-7 jours effort).

---

**Derni√®re mise √† jour** : 2025-10-10
**Audit r√©alis√© par** : Claude Code
**Prochaine revue** : Fin Semaine 3 (apr√®s int√©gration pipeline)
