x-common-config: &common-config
  stop_grace_period: 10s

services:
  qdrant:
    <<: *common-config
    image: qdrant/qdrant:v1.15.1
    container_name: knowbase-qdrant
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage # volume Docker natif
    #healthcheck:
    #  test: ["CMD-SHELL", "nc -z localhost 6333"]
    #  interval: 10s
    #  timeout: 5s
    #  retries: 5
    environment:
      - QDRANT__STORAGE__CHECK_FS=false
      - QDRANT__STORAGE__STRICT=false
    networks:
      - knowbase_net

  redis:
    <<: *common-config
    image: redis:7.2
    container_name: knowbase-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    networks:
      - knowbase_net

  app:
    build:
      context: .
      dockerfile: ./app/Dockerfile
    image: sap-kb-app:latest
    container_name: knowbase-app
    depends_on:
      - qdrant
      - redis
    stop_grace_period: 10s
    env_file:
      - .env
    environment:
      TZ: Europe/Paris  # Timezone Paris pour tous les logs
      PYTHONPATH: /app:/app/src
      HF_HOME: /data/models
      KNOWBASE_DATA_DIR: /data
      REDIS_URL: redis://redis:6379/0
    ports:
      - "${APP_PORT}:8000"
      - "5678:5678"
    volumes:
      - ./app:/app
      - ./data:/data
      - ./src:/app/src
      - ./config:/app/config
      - ./tests:/app/tests
    networks:
      - knowbase_net
    working_dir: /app
    command: python -Xfrozen_modules=off -m uvicorn main:app --host 0.0.0.0 --port 8000

  ingestion-worker:
    build:
      context: .
      dockerfile: ./app/Dockerfile
    image: sap-kb-worker:latest
    container_name: knowbase-worker
    restart: unless-stopped
    depends_on:
      - redis
      - qdrant
    stop_grace_period: 15s
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1  # Utiliser 1 GPU (Docker Desktop Windows ne supporte pas device_ids)
              capabilities: [gpu]
    env_file:
      - .env
    environment:
      TZ: Europe/Paris  # Timezone Paris pour tous les logs
      PYTHONPATH: /app:/app/src
      HF_HOME: /data/models
      KNOWBASE_DATA_DIR: /data
      REDIS_URL: redis://redis:6379/0
      DEV_MODE: "false"  # Mode production: worker tourne en continu (10 jobs avant reload)

      # ========== CONFIGURATION TIMEOUT CENTRALIS√âE ==========
      # üéØ VARIABLE CENTRALE - Ajuster cette valeur unique pour contr√¥ler tous les timeouts de pipeline
      # Dur√©e maximale de traitement d'un document (en secondes)
      #
      # Recommandations selon complexit√© documents:
      #   - 3600s (1h)   ‚Üí Documents standards (< 300 slides) ‚úÖ D√âFAUT
      #   - 5400s (1h30) ‚Üí Documents complexes (300-500 slides)
      #   - 7200s (2h)   ‚Üí Documents tr√®s complexes (> 500 slides)
      #
      # Les timeouts ci-dessous sont calcul√©s automatiquement:
      #   - INGESTION_JOB_TIMEOUT = MAX_DOCUMENT_PROCESSING_TIME * 1.5 (buffer RQ)
      #   - OSMOSE_TIMEOUT_SECONDS = MAX_DOCUMENT_PROCESSING_TIME
      MAX_DOCUMENT_PROCESSING_TIME: "3600"  # 1 heure (support jusqu'√† ~45 min de processing)

      # Variables legacy (OPTIONNELLES - d√©commenter pour override manuel):
      # OSMOSE_TIMEOUT_SECONDS: "3600"      # Auto: MAX_DOCUMENT_PROCESSING_TIME
      # INGESTION_JOB_TIMEOUT: "5400"       # Auto: MAX_DOCUMENT_PROCESSING_TIME * 1.5

      CUDA_VISIBLE_DEVICES: "0"  # Exposer GPU comme device 0 dans le container (mapping de host device 1)
    ports:
      - "5679:5679"  # Debug port for worker
    volumes:
      - ./app:/app
      - ./data:/data
      - ./src:/app/src
      - ./config:/app/config
      - ./tests:/app/tests
    networks:
      - knowbase_net
    working_dir: /app
    entrypoint: ["/app/entrypoint-worker.sh"]
    command: python -m knowbase.ingestion.queue

  folder-watcher:
    build:
      context: .
      dockerfile: ./app/Dockerfile
    image: sap-kb-watcher:latest
    container_name: knowbase-watcher
    depends_on:
      - redis
    stop_grace_period: 10s
    env_file:
      - .env
    environment:
      TZ: Europe/Paris
      PYTHONPATH: /app:/app/src
      KNOWBASE_DATA_DIR: /data
      REDIS_URL: redis://redis:6379/0
    volumes:
      - ./app:/app
      - ./data:/data
      - ./src:/app/src
      - ./config:/app/config
    networks:
      - knowbase_net
    working_dir: /app
    command: python -m knowbase.ingestion.folder_watcher
    restart: unless-stopped

  ui:
    build:
      context: ./ui
      dockerfile: Dockerfile
    image: sap-kb-ui:latest
    container_name: knowbase-ui
    depends_on:
      - app
    stop_grace_period: 10s
    env_file:
      - .env
    environment:
      BACKEND_URL: ${BACKEND_URL}
      PYTHONPATH: /app/src
      KNOWBASE_DATA_DIR: /data
    ports:
      - "${APP_UI_PORT}:8501"
    volumes:
      - ./ui:/app
      - ./src:/app/src
      - ./data:/data
    networks:
      - knowbase_net

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    image: sap-kb-frontend:latest
    container_name: knowbase-frontend
    depends_on:
      - app
    stop_grace_period: 10s
    env_file:
      - .env
    environment:
      - NODE_ENV=development
      - NEXT_TELEMETRY_DISABLED=1
      - WATCHPACK_POLLING=true
      - CHOKIDAR_USEPOLLING=true
      # API URLs - Client uses localhost, Server uses Docker service name
      - NEXT_PUBLIC_API_BASE_URL=http://localhost:8000
      - NEXT_PUBLIC_API_INTERNAL_URL=http://app:8000
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      - frontend_node_modules:/app/node_modules
      - frontend_next_build:/app/.next  # Volume pour .next (evite problemes permissions)
      - ./frontend/next.config.js:/app/next.config.js
      - ./frontend/package.json:/app/package.json
      - ./frontend/tsconfig.json:/app/tsconfig.json
      - ./frontend/tailwind.config.js:/app/tailwind.config.js
      - ./frontend/warmup.js:/app/warmup.js
    command: npm run dev
    networks:
      - knowbase_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ngrok: # D√âSACTIV√â - N√©cessite plan payant pour custom subdomain
  #   image: ngrok/ngrok:latest
  #   container_name: knowbase-ngrok
  #   restart: unless-stopped
  #   depends_on:
  #     - app
  #   volumes:
  #     - ./ngrok.yml:/etc/ngrok.yml
  #     - ./data/logs:/logs
  #     - ./src:/app/src
  #   env_file:
  #     - .env
  #   command: start --config /etc/ngrok.yml --all
  #   networks:
  #     - knowbase_net

networks:
  knowbase_net:
    name: knowbase_network
    driver: bridge

volumes:
  qdrant_data:
    name: knowbase_qdrant_data  # Doit matcher docker-compose.infra.yml
  redis_data:
    name: knowbase_redis_data   # Doit matcher docker-compose.infra.yml
  frontend_node_modules:
    name: knowbase_frontend_node_modules
  frontend_next_build:
    name: knowbase_frontend_next_build

