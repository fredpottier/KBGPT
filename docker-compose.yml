x-common-config: &common-config
  stop_grace_period: 10s

services:
  qdrant:
    <<: *common-config
    image: qdrant/qdrant:v1.15.1
    container_name: knowbase-qdrant
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage # volume Docker natif
    #healthcheck:
    #  test: ["CMD-SHELL", "nc -z localhost 6333"]
    #  interval: 10s
    #  timeout: 5s
    #  retries: 5
    environment:
      - QDRANT__STORAGE__CHECK_FS=false
      - QDRANT__STORAGE__STRICT=false
    networks:
      - knowbase_net

  redis:
    <<: *common-config
    image: redis:7.2
    container_name: knowbase-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    networks:
      - knowbase_net

  app:
    build:
      context: .
      dockerfile: ./app/Dockerfile
    image: sap-kb-app:latest
    container_name: knowbase-app
    depends_on:
      - qdrant
      - redis
    stop_grace_period: 10s
    env_file:
      - .env
    environment:
      PYTHONPATH: /app:/app/src
      HF_HOME: /data/models
      KNOWBASE_DATA_DIR: /data
      REDIS_URL: redis://redis:6379/0
    ports:
      - "${APP_PORT}:8000"
      - "5678:5678"
    volumes:
      - ./app:/app
      - ./data:/data
      - ./src:/app/src
      - ./config:/app/config
      - ./tests:/app/tests
    networks:
      - knowbase_net
    working_dir: /app
    command: python -Xfrozen_modules=off -m uvicorn main:app --host 0.0.0.0 --port 8000

  ingestion-worker:
    build:
      context: .
      dockerfile: ./app/Dockerfile
    image: sap-kb-worker:latest
    container_name: knowbase-worker
    depends_on:
      - redis
      - qdrant
    stop_grace_period: 15s
    env_file:
      - .env
    environment:
      PYTHONPATH: /app:/app/src
      HF_HOME: /data/models
      KNOWBASE_DATA_DIR: /data
      REDIS_URL: redis://redis:6379/0
      DEV_MODE: "true"  # Auto-reload du code après chaque job (désactiver en prod)
    ports:
      - "5679:5679"  # Debug port for worker
    volumes:
      - ./app:/app
      - ./data:/data
      - ./src:/app/src
      - ./config:/app/config
      - ./tests:/app/tests
    networks:
      - knowbase_net
    working_dir: /app
    entrypoint: ["/app/entrypoint-worker.sh"]
    command: python -m knowbase.ingestion.queue

  ui:
    build:
      context: ./ui
      dockerfile: Dockerfile
    image: sap-kb-ui:latest
    container_name: knowbase-ui
    depends_on:
      - app
    stop_grace_period: 10s
    env_file:
      - .env
    environment:
      BACKEND_URL: ${BACKEND_URL}
      PYTHONPATH: /app/src
      KNOWBASE_DATA_DIR: /data
    ports:
      - "${APP_UI_PORT}:8501"
    volumes:
      - ./ui:/app
      - ./src:/app/src
      - ./data:/data
    networks:
      - knowbase_net

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    image: sap-kb-frontend:latest
    container_name: knowbase-frontend
    depends_on:
      - app
    stop_grace_period: 10s
    env_file:
      - .env
    environment:
      - NODE_ENV=development
      - NEXT_TELEMETRY_DISABLED=1
      - WATCHPACK_POLLING=true
      - CHOKIDAR_USEPOLLING=true
      # API URLs - Client uses localhost, Server uses Docker service name
      - NEXT_PUBLIC_API_BASE_URL=http://localhost:8000
      - NEXT_PUBLIC_API_INTERNAL_URL=http://app:8000
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      - frontend_node_modules:/app/node_modules
      - ./frontend/next.config.js:/app/next.config.js
      - ./frontend/package.json:/app/package.json
      - ./frontend/tsconfig.json:/app/tsconfig.json
      - ./frontend/tailwind.config.js:/app/tailwind.config.js
      - ./frontend/warmup.js:/app/warmup.js
    command: npm run dev
    networks:
      - knowbase_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  ngrok:
    image: ngrok/ngrok:latest
    container_name: knowbase-ngrok
    restart: unless-stopped
    depends_on:
      - app
    volumes:
      - ./ngrok.yml:/etc/ngrok.yml
      - ./data/logs:/logs
      - ./src:/app/src
    env_file:
      - .env
    command: start --config /etc/ngrok.yml --all
    networks:
      - knowbase_net

networks:
  knowbase_net:
    name: knowbase_network
    driver: bridge

volumes:
  qdrant_data: # volume Docker local (resout l'erreur Qdrant)
  redis_data: # volume Docker pour la persistance Redis
  frontend_node_modules: # volume Docker pour éviter les conflits de permissions npm

