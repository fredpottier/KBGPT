# OSMOSE Pipeline V2 - Prompts Pass 1
# =====================================
# Ref: doc/ongoing/ARCH_STRATIFIED_PIPELINE_V2.md
# Date: 2026-01-24

# ============================================================================
# PHASE 1.1: Document Analysis
# ============================================================================

document_analysis:
  # V2.2: English prompts for better LLM quality + themes in document language
  system: |
    You are a document analysis expert for OSMOSE.
    Analyze the document and determine:

    1. Its main SUBJECT (1 concise sentence that captures the document's INTENT,
       not just what it describes, but what it seeks to establish, prove, or delimit)
    2. Its dependency STRUCTURE:
       - CENTRAL: Document depends on a central context (e.g., product guide, specific technical documentation)
       - TRANSVERSAL: Independent reference applicable across contexts (e.g., GDPR regulation, ISO standard)
       - CONTEXTUAL: Document combines multiple contexts or is mixed in nature
    3. Its major THEMES (7-12, adaptive to document complexity)
    4. The document LANGUAGE (fr, en, de)

    CRITICAL RULES FOR THEMES:
    - ADAPTIVE COUNT: Use 7-12 themes depending on document complexity.
      A document with many distinct top-level sections (chapters) should have MORE themes.
      Each major chapter or agenda item deserves its own theme.
    - STRUCTURAL SIGNAL: The Table of Contents / Agenda is the PRIMARY source for themes.
      Every top-level section (H1/H2) should map to at least one theme.
    - DO NOT MERGE distinct operational domains into one theme
      (e.g., "Security Operations" must NOT absorb "Patch Management" or "Disaster Recovery")
    - Include themes for LIFECYCLE topics (backup, patching, monitoring) not just static descriptions
    - Include themes for BOUNDARIES (responsibilities, limitations, what is NOT covered)
    - Subject must be 1 sentence, not a paragraph
    - Structure justification must be brief but precise
    - ⚠️ LANGUAGE DETECTION: Analyze the document content to determine the language
      (not the prompt language!). If content has "the", "is", "are" → "en".
      If content has "le", "la", "les" → "fr". If content has "der", "die", "das" → "de".
    - ⚠️ THEMES MUST BE IN THE DOCUMENT'S LANGUAGE (if document is English, themes in English)

  user: |
    Analyze this document:

    TITLE: {doc_title}

    TABLE OF CONTENTS:
    {toc}

    CONTENT (first {char_limit} characters):
    {content_preview}

    ⚠️ IMPORTANT: Write themes in the SAME LANGUAGE as the document content.

    Reply ONLY with this JSON:
    ```json
    {{
      "subject_name": "Short subject name (5-10 words max)",
      "subject": "Subject summary in 1 sentence",
      "structure": {{
        "chosen": "CENTRAL|TRANSVERSAL|CONTEXTUAL",
        "justification": "Why this structure (1-2 sentences)"
      }},
      "themes": [
        "Theme 1 (in document language)",
        "Theme 2 (in document language)",
        "Theme 3 (in document language)"
      ],
      "language": "fr|en|de"
    }}
    ```

# ============================================================================
# PHASE 1.2: Concept Identification (V2.2 - English + Adaptive Budget)
# ============================================================================

concept_identification:
  # V2.2: English prompts + adaptive budget + lexical_triggers mandatory
  system: |
    Expert concept extraction for OSMOSE knowledge system.

    YOUR GOAL: Extract {max_concepts} SPECIFIC concepts that cover the document's knowledge.

    ⚠️ CRITICAL RULE - LEXICAL TRIGGERS (C1):
    Each concept MUST have 2-4 "lexical_triggers":
    - Tokens or expressions that ACTUALLY APPEAR VERBATIM in the document
    - MUST be in the SAME LANGUAGE as the document content
    - Copy exact tokens from the document (no translation, no paraphrasing)
    - These triggers are used for keyword matching to find the concept in the text

    CONCEPT NAMING RULES:
    - Use 2-5 descriptive words
    - Use the DOCUMENT'S LANGUAGE for concept names AND triggers
    - Be SPECIFIC, not generic
    - Include technical terms, product names, specific features

    EXAMPLES OF GOOD vs BAD CONCEPTS:
    ❌ "security" → too generic
    ❌ "data management" → too vague
    ❌ "compliance requirements" → no observable triggers
    ✅ "TLS 1.2 encryption" with triggers ["TLS", "1.2", "encryption"]
    ✅ "availability zone failover" with triggers ["availability zone", "failover", "HA"]
    ✅ "customer subnet isolation" with triggers ["customer subnet", "isolation", "VPC"]

    ROLES (use all 3 proportionally):
    - CENTRAL: Core document topics (20-30% of concepts)
    - STANDARD: Important secondary topics (50-60% of concepts)
    - CONTEXTUAL: Technical context (15-25% of concepts)

    TERMS TO REFUSE:
    - Generic without observable triggers ("data", "system", "process", "management")
    - Mentioned only once without definition
    - Undefined acronyms
    - Vague terms applicable to anything ("requirement", "standard", "solution")

    FORMAT: Compact JSON only, NO explanatory text.

  user: |
    Extract KEY concepts from this document.

    SUBJECT: {subject}
    STRUCTURE: {structure}
    LANGUAGE: {language}

    AVAILABLE THEMES:
    {themes}

    CONTENT (extract):
    {content}

    RULES:
    - Extract between 20 and {max_concepts} concepts (aim for {max_concepts})
    - Each concept MUST have 2-4 lexical_triggers (tokens present in the text)
    - Concept names AND lexical_triggers in the DOCUMENT'S LANGUAGE ({language})
    - Triggers MUST be copied verbatim from the document text (no translation!)
    - Use all 3 role levels proportionally
    - Be SPECIFIC: "FWaaS network security" not just "security"

    Reply ONLY with this JSON:
    ```json
    {{
      "concepts": [
        {{
          "name": "Specific name (2-5 words, in {language})",
          "role": "CENTRAL|STANDARD|CONTEXTUAL",
          "theme": "Theme name",
          "lexical_triggers": ["token1", "token2", "token3"]
        }}
      ],
      "refused_terms": [
        {{"term": "Term", "reason": "Reason"}}
      ]
    }}
    ```

# ============================================================================
# PHASE 1.3: Assertion Extraction
# ============================================================================

assertion_extraction:
  # V2.2: English prompts
  system: |
    You are an assertion extraction expert for OSMOSE.
    An ASSERTION is a sentence or text segment that carries KNOWLEDGE:

    ASSERTION TYPES:
    - definitional: Defines what something is ("X is defined as...")
    - prescriptive: Obligation, rule ("X must...", "X shall...")
    - factual: Verifiable information ("X contains...", "X was created in...")
    - permissive: Possibility, option ("X may...", "X can...")
    - conditional: Condition ("If X then Y", "When X...")
    - causal: Cause/consequence ("X leads to Y", "X results in Y")
    - procedural: Steps, process ("Step 1: ...", "First, ...")
    - comparative: Comparison ("X is better than Y")

    RULES:
    - Detect the LANGUAGE of each assertion
    - Confidence should reflect assertion clarity
    - Ignore trivial or repetitive assertions

  user: |
    Extract assertions from this text.

    CHUNK_ID: {chunk_id}
    EXPECTED LANGUAGE: {language_hint}

    TEXT:
    {text}

    Reply ONLY with this JSON:
    ```json
    {{
      "assertions": [
        {{
          "text": "EXACT text of assertion (copied from text)",
          "type": "definitional|factual|prescriptive|permissive|conditional|causal|procedural|comparative",
          "start_char": 145,
          "end_char": 287,
          "confidence": 0.9,
          "language": "fr|en|de"
        }}
      ]
    }}
    ```

# ============================================================================
# PHASE 1.3: Semantic Linking
# ============================================================================

semantic_linking:
  # V2.2: English prompts + Multi-Concept Linking
  system: |
    You are a semantic reasoning expert for OSMOSE.
    Determine which ASSERTIONS provide knowledge about which CONCEPTS.

    ⚠️ IMPORTANT: An assertion can relate to MULTIPLE concepts (1-5)!

    Example: "S/4HANA Migration requires ABAP and JavaScript skills"
    → Concepts: ["S/4HANA Migration", "ABAP skills", "JavaScript skills"]

    This is NOT lexical matching:
    - An assertion can relate to a concept WITHOUT mentioning it explicitly
    - A French concept can be linked to an English assertion (and vice versa)
    - The link must be SEMANTIC (based on meaning), not lexical (based on words)

    LINK TYPES:
    - defines: Assertion DEFINES the concept (explicit definition)
    - describes: Assertion DESCRIBES a property or characteristic of the concept
    - constrains: Assertion IMPOSES a constraint or limitation on the concept
    - enables: Assertion says what the concept ALLOWS or makes possible
    - conditions: Assertion specifies a CONDITION related to the concept
    - causes: Assertion describes an EFFECT or consequence of the concept

    RULE C3 - Avoid "spray & pray":
    - Maximum 5 concepts per assertion
    - Only link if confidence >= 0.70
    - Justify each link precisely

  user: |
    Establish semantic links between these assertions and concepts.

    ASSERTIONS (to link):
    {assertions}

    CONCEPTS (targets):
    {concepts}

    ⚠️ MULTI-CONCEPT: An assertion can be linked to MULTIPLE concepts (1-5 max).

    Reply ONLY with this JSON:
    ```json
    {{
      "links": [
        {{
          "assertion_id": "assert_abc123",
          "concept_links": [
            {{
              "concept_id": "concept_xyz1",
              "link_type": "defines",
              "justification": "This assertion defines the concept because...",
              "confidence": 0.85
            }},
            {{
              "concept_id": "concept_xyz2",
              "link_type": "describes",
              "justification": "This assertion also describes this concept because...",
              "confidence": 0.75
            }}
          ]
        }}
      ],
      "unlinked_assertions": [
        {{
          "assertion_id": "assert_def456",
          "reason": "This assertion does not relate to any identified concept because..."
        }}
      ]
    }}
    ```

# ============================================================================
# PHASE 1.3 POINTER: Pointer-Based Extraction (Anti-Reformulation)
# ============================================================================
# This prompt uses numbered units to prevent LLM reformulation.
# The LLM POINTS to a unit (U1, U2...) instead of COPYING the text.

pointer_concept_extraction:
  # V2.2: English prompts + labels must use text words
  system: |
    You are a concept extraction expert for OSMOSE.

    POINTER-BASED METHOD:
    Text is split into numbered units (U1, U2, U3...).
    You must POINT to the unit containing the concept, NOT copy the text.

    CONCEPT TYPES:
    - PRESCRIPTIVE: Obligation, rule ("must", "shall", "required")
    - DEFINITIONAL: Definition, explanation ("is defined as", "refers to")
    - FACTUAL: Verifiable information, technical fact
    - PERMISSIVE: Option, possibility ("may", "can", "optional")

    CRITICAL RULES:
    1. Return ONLY the unit number (U1, U2...), NEVER the text
    2. ONLY propose a concept IF you can POINT to a unit
    3. IF no unit matches, DO NOT return the concept
    4. ⚠️ The LABEL must contain AT LEAST 2 WORDS present in the unit text
    5. ❌ DO NOT invent abstract labels like "security requirement" or "data protection"
    6. ✅ USE exact words from the text to build the label

    STRICT JSON FORMAT - no text outside JSON.

  user: |
    Extract concepts from this text with numbered units.

    DOCITEM_ID: {docitem_id}
    LANGUAGE: {language}

    TEXT WITH UNITS:
    {units_text}

    CRITICAL INSTRUCTIONS:
    - Indicate ONLY the unit number (U1, U2...).
    - DO NOT copy the full text.
    - ⚠️ The LABEL must use WORDS PRESENT in the pointed unit.
    - ❌ FORBIDDEN: abstract labels ("security requirement", "compliance standard")
    - ✅ CORRECT: labels with text words ("TLS version", "data encryption", "audit trail")

    EXAMPLES:
    - Unit: "TLS 1.2 is required" → label: "TLS version" ✅ (words present)
    - Unit: "All data must be encrypted" → label: "data encryption" ✅ (words present)
    - Unit: "All data must be encrypted" → label: "security requirement" ❌ (words absent)

    Reply ONLY with this JSON:
    ```json
    {{
      "concepts": [
        {{
          "label": "Name with TEXT WORDS (2-5 words)",
          "type": "PRESCRIPTIVE|DEFINITIONAL|FACTUAL|PERMISSIVE",
          "unit_id": "U1",
          "confidence": 0.9
        }}
      ]
    }}
    ```

# ============================================================================
# PHASE 1.3 POINTER: Batch Extraction (multiple DocItems)
# ============================================================================

pointer_batch_extraction:
  # V2.2: English prompts + labels must use text words
  system: |
    Expert concept extraction OSMOSE - BATCH POINTER MODE.

    METHOD:
    - Each block [DOCITEM: xxx] contains numbered units
    - You must POINT to units (U1, U2...) without copying the text
    - Include docitem_id in each extracted concept

    TYPES: PRESCRIPTIVE | DEFINITIONAL | FACTUAL | PERMISSIVE

    CRITICAL RULES:
    1. ONLY the unit number, NEVER the text
    2. No concept if no unit matches
    3. ⚠️ The LABEL must contain AT LEAST 2 WORDS from the pointed unit
    4. ❌ FORBIDDEN: abstract labels (security requirement, data protection, compliance)
    5. ✅ USE exact words from the text

    COMPACT JSON FORMAT.

  user: |
    Extract concepts from these DocItems.

    LANGUAGE: {language}

    {docitems_with_units}

    ⚠️ LABEL RULE: Use WORDS PRESENT in the unit, not abstract terms.

    Reply with this JSON:
    ```json
    {{
      "concepts": [
        {{
          "docitem_id": "default:doc_abc:#/texts/5",
          "label": "Name with TEXT WORDS",
          "type": "PRESCRIPTIVE",
          "unit_id": "U1",
          "confidence": 0.9
        }}
      ]
    }}
    ```

# ============================================================================
# PHASE 1.2b: Concept Identification BY THEME (Batch Mode)
# ============================================================================
# Extraction par batch thématique pour éviter troncature JSON
# Chaque thème = 1 appel LLM avec quota limité (~10-12 concepts)
# Ref: doc/ongoing/PLAN_CONCEPT_BATCH_THEMATIQUE.md

concept_identification_by_theme:
  system: |
    Expert concept extraction for OSMOSE knowledge system.

    You are extracting concepts for ONE SPECIFIC THEME only.

    CONCEPT NAMING RULES:
    - Use 2-5 descriptive words
    - Use the DOCUMENT'S LANGUAGE for concept names
    - Be SPECIFIC, not generic (e.g., "TLS encryption requirement" not "security")

    ⚠️ CRITICAL RULE - LEXICAL TRIGGERS (C1):
    Each concept MUST have exactly 3 "lexical_triggers" that:
    1. ACTUALLY APPEAR VERBATIM in the document content (SAME LANGUAGE as document!)
    2. Are NOT in the FORBIDDEN_TRIGGERS list (too frequent)
    3. Are COPIED from the document text (NO translation, NO paraphrasing)
    4. Include at least ONE discriminant trigger:
       - Technical acronym (TLS, MFA, KMS, BYOK, HSM, SLA, RTO, RPO, etc.)
       - Product name (SAProuter, Fiori, S/4HANA, BTP, etc.)
       - Specific term (whitelisting, failover, provisioning, etc.)
       - OR a composite trigger in snake_case (e.g., "sap_cloud_erp_private")

    ⚠️ COMPOSITE TRIGGERS:
    If the concept name is a multi-word proper noun or product name, include ONE
    trigger as a composite snake_case token formed from the key words.
    Example: concept "SAP Cloud ERP Private" → trigger "sap_cloud_erp_private"

    ⚠️ FORBIDDEN: Do NOT use theme words alone as triggers.
    Theme "{theme_name}" words are too generic. Find SPECIFIC terms.

    ROLES:
    - CENTRAL: Core mechanism/product of this theme (1-2 per theme)
    - STANDARD: Important related concepts (majority)
    - CONTEXTUAL: Supporting technical context

    FORMAT: Compact JSON only, NO explanatory text.

  user: |
    Extract concepts for the theme "{theme_name}" from this document.

    DOCUMENT SUBJECT: {subject}
    THEME TO EXTRACT: {theme_name}
    LANGUAGE: {language}
    MAX CONCEPTS FOR THIS THEME: {max_concepts_per_theme}

    ⚠️ FORBIDDEN TRIGGERS (too frequent in document - DO NOT USE):
    {forbidden_triggers}

    CONTENT RELEVANT TO THIS THEME:
    {theme_content}

    Reply ONLY with this JSON:
    ```json
    {{
      "concepts": [
        {{
          "name": "Specific name (2-5 words)",
          "role": "CENTRAL|STANDARD|CONTEXTUAL",
          "lexical_triggers": ["specific_term", "acronym", "composite_snake_case"]
        }}
      ],
      "refused_terms": [
        {{"term": "Term", "reason": "NO_COMPLIANT_TRIGGERS"}}
      ]
    }}
    ```

    IMPORTANT: If you cannot find 3 compliant triggers for a concept, put it in
    refused_terms with reason "NO_COMPLIANT_TRIGGERS" instead of outputting it.

# ============================================================================
# PHASE 1.2c: Concept Refinement (Iterative - V2.2)
# ============================================================================

concept_refinement:
  # V2.2: English prompts
  system: |
    You are an expert in identifying MISSING concepts for OSMOSE.

    CONTEXT:
    You are given assertions that COULD NOT be linked to existing concepts.
    Your task: identify MISSING concepts that would capture them.

    CRITICAL RULES:
    - SPECIFIC and ACTIONABLE concepts (not generic)
    - Do NOT repeat existing concepts
    - Maximum {max_concepts} new concepts per iteration
    - Each concept must match AT LEAST 2 provided assertions

    ⚠️ CRITERION C2 - Quality assertions:
    A new concept must cover at least 1 quality assertion:
    - PRESCRIPTIVE (must, shall, required)
    - Value-bearing (contains a value: %, version, duration, size)
    - Implicit obligation (is required to, no later than, within X days)

    ⚠️ LEXICAL TRIGGERS (C1):
    Each new concept MUST have 2-4 lexical_triggers:
    - Tokens that APPEAR VERBATIM in the provided assertions
    - SAME LANGUAGE as the assertions (no translation!)
    - No paraphrases or invented synonyms

    EXAMPLES:
    Unlinked assertions:
    - "Data retention period is 5 years"
    - "Personal data must be deleted after retention"
    → New concept: {{"name": "data retention period", "lexical_triggers": ["retention", "5 years", "deleted"]}}

  user: |
    Identify MISSING concepts from these unlinked assertions.

    UNLINKED ASSERTIONS (extracts):
    {assertions}

    EXISTING CONCEPTS (do not repeat):
    {existing_concepts}

    AVAILABLE THEMES:
    {themes}

    LANGUAGE: {language}

    RULES:
    - Maximum {max_concepts} new concepts
    - Each concept must cover ≥2 assertions including ≥1 PRESCRIPTIVE or value-bearing
    - Include 2-4 lexical_triggers per concept
    - Concept names in {language}

    Reply ONLY with this JSON:
    ```json
    {{
      "new_concepts": [
        {{
          "name": "Specific name (2-5 words, in {language})",
          "role": "CENTRAL|STANDARD|CONTEXTUAL",
          "theme": "Existing theme",
          "lexical_triggers": ["token1", "token2", "token3"],
          "covers_assertions_count": 3,
          "has_prescriptive_or_value": true
        }}
      ],
      "uncapturable": [
        {{
          "reason": "These assertions are too generic/fragmentary to justify a concept"
        }}
      ]
    }}
    ```
