# OSMOSE Pipeline V2 - Prompts Pass 1
# =====================================
# Ref: doc/ongoing/ARCH_STRATIFIED_PIPELINE_V2.md
# Date: 2026-01-24

# ============================================================================
# PHASE 1.1: Document Analysis
# ============================================================================

document_analysis:
  system: |
    Tu es un expert en analyse documentaire pour OSMOSE.
    Tu dois analyser le document et déterminer:

    1. Son SUJET principal (résumé en 1 phrase concise)
    2. Sa STRUCTURE de dépendance:
       - CENTRAL: Le document dépend d'un contexte central (ex: guide produit SAP, documentation technique spécifique)
       - TRANSVERSAL: Le document est une référence indépendante applicable dans plusieurs contextes (ex: réglementation GDPR, norme ISO)
       - CONTEXTUAL: Le document combine plusieurs contextes ou est de nature mixte
    3. Ses THEMES majeurs (5-10 maximum, pas plus)
    4. La LANGUE du document (fr, en, de)

    RÈGLES IMPORTANTES:
    - Sois FRUGAL: maximum 10 thèmes
    - Le sujet doit être en 1 phrase, pas un paragraphe
    - La justification de la structure doit être brève mais précise

  user: |
    Analyse ce document:

    TITRE: {doc_title}

    TABLE DES MATIÈRES:
    {toc}

    CONTENU (premiers {char_limit} caractères):
    {content_preview}

    Réponds UNIQUEMENT avec ce JSON:
    ```json
    {{
      "subject_name": "Nom court du sujet (5-10 mots max)",
      "subject": "Résumé du sujet en 1 phrase",
      "structure": {{
        "chosen": "CENTRAL|TRANSVERSAL|CONTEXTUAL",
        "justification": "Pourquoi cette structure (1-2 phrases)"
      }},
      "themes": [
        "Thème 1",
        "Thème 2",
        "Thème 3"
      ],
      "language": "fr|en|de"
    }}
    ```

# ============================================================================
# PHASE 1.2: Concept Identification (V2.1 - Surface Élargie + Lexical Triggers)
# ============================================================================

concept_identification:
  # V2.1: Surface conceptuelle élargie (20-30 concepts) avec lexical_triggers obligatoires
  system: |
    Expert extraction concepts OSMOSE.

    COUVERTURE PRIORITAIRE:
    - Identifier 20-30 concepts pour couvrir la richesse documentaire
    - Concepts SPÉCIFIQUES (2-5 mots descriptifs)
    - Éviter les concepts génériques ("security", "system", "data")

    ⚠️ RÈGLE CRITIQUE - LEXICAL TRIGGERS (C1):
    Chaque concept DOIT avoir 2-4 "lexical_triggers":
    - Tokens ou expressions qui APPARAISSENT RÉELLEMENT dans le document
    - Pas de paraphrases ou synonymes inventés
    - Ces triggers servent à retrouver le concept dans le texte

    ⚠️ INDÉPENDANCE DOMAINE:
    Ne suppose aucun domaine. Les triggers doivent venir du texte.

    EXEMPLES:
    ❌ {{"name": "compliance", "lexical_triggers": []}} → REJETÉ
    ✅ {{"name": "délai conservation données", "lexical_triggers": ["conservation", "5 ans", "RGPD"]}}
    ✅ {{"name": "TLS version minimale", "lexical_triggers": ["TLS", "1.2", "connexion"]}}
    ✅ {{"name": "uptime SLA", "lexical_triggers": ["uptime", "99.9%", "SLA"]}}

    RÔLES (utiliser les 3):
    - CENTRAL: Cœur du document (5-8 concepts)
    - STANDARD: Important mais secondaire (10-15 concepts)
    - CONTEXTUAL: Contexte technique (5-7 concepts)

    TERMES À REFUSER (tous domaines):
    - Génériques sans triggers observables ("data", "system", "process", "compliance", "management")
    - Mentionnés une seule fois sans définition
    - Acronymes non définis dans le texte
    - Termes vagues applicable à tout ("requirement", "standard", "solution")

    FORMAT: JSON compact uniquement, PAS de texte explicatif.

  user: |
    Identifie les concepts CLÉS de ce document.

    SUJET: {subject}
    STRUCTURE: {structure}
    LANGUE: {language}

    THÈMES DISPONIBLES:
    {themes}

    CONTENU (extrait):
    {content}

    RÈGLES:
    - Minimum 15, maximum {max_concepts} concepts
    - Chaque concept DOIT avoir 2-4 lexical_triggers (tokens présents dans le texte)
    - Concepts SPÉCIFIQUES (pas génériques)
    - Utiliser les 3 niveaux de rôle

    Réponds UNIQUEMENT avec ce JSON:
    ```json
    {{
      "concepts": [
        {{
          "name": "Nom spécifique (2-5 mots)",
          "role": "CENTRAL|STANDARD|CONTEXTUAL",
          "theme": "Thème",
          "lexical_triggers": ["token1", "token2", "token3"]
        }}
      ],
      "refused_terms": [
        {{"term": "Terme", "reason": "Raison"}}
      ]
    }}
    ```

# ============================================================================
# PHASE 1.3: Assertion Extraction
# ============================================================================

assertion_extraction:
  system: |
    Tu es un expert en extraction d'assertions pour OSMOSE.
    Une ASSERTION est une phrase ou segment de texte qui porte une CONNAISSANCE:

    TYPES D'ASSERTIONS:
    - definitional: Définit ce qu'est quelque chose ("X est défini comme...")
    - prescriptive: Obligation, règle ("X doit...", "X shall...")
    - factual: Information vérifiable ("X contient...", "X a été créé en...")
    - permissive: Possibilité, option ("X peut...", "X may...")
    - conditional: Condition ("Si X alors Y", "When X...")
    - causal: Cause/conséquence ("X entraîne Y", "X leads to Y")
    - procedural: Étapes, processus ("Étape 1: ...", "First, ...")
    - comparative: Comparaison ("X est meilleur que Y")

    RÈGLES:
    - Retourne les positions EXACTES dans le texte (start_char, end_char)
    - Détecte la LANGUE de chaque assertion
    - La confiance doit refléter la clarté de l'assertion
    - Ignore les assertions triviales ou répétitives

  user: |
    Extrait les assertions de ce texte.

    CHUNK_ID: {chunk_id}
    LANGUE ATTENDUE: {language_hint}

    TEXTE:
    {text}

    Réponds UNIQUEMENT avec ce JSON:
    ```json
    {{
      "assertions": [
        {{
          "text": "Le texte EXACT de l'assertion (copié du texte)",
          "type": "definitional|factual|prescriptive|permissive|conditional|causal|procedural|comparative",
          "start_char": 145,
          "end_char": 287,
          "confidence": 0.9,
          "language": "fr|en|de"
        }}
      ]
    }}
    ```

# ============================================================================
# PHASE 1.3: Semantic Linking
# ============================================================================

semantic_linking:
  # V2.1: Multi-Concept Linking - une assertion peut informer 1-5 concepts
  system: |
    Tu es un expert en raisonnement sémantique pour OSMOSE.
    Tu dois déterminer quelles ASSERTIONS apportent de la connaissance sur quels CONCEPTS.

    ⚠️ IMPORTANT: Une assertion peut concerner PLUSIEURS concepts (1-5)!

    Exemple: "S/4HANA Migration requires ABAP and JavaScript skills"
    → Concepts: ["S/4HANA Migration", "ABAP skills", "JavaScript skills"]

    Ce n'est PAS un matching lexical:
    - Une assertion peut concerner un concept SANS le mentionner explicitement
    - Un concept en français peut être lié à une assertion en anglais (et vice versa)
    - Le lien doit être SÉMANTIQUE (basé sur le sens), pas lexical (basé sur les mots)

    TYPES DE LIENS:
    - defines: L'assertion DÉFINIT le concept (définition explicite)
    - describes: L'assertion DÉCRIT une propriété ou caractéristique du concept
    - constrains: L'assertion IMPOSE une contrainte ou limitation sur le concept
    - enables: L'assertion dit ce que le concept PERMET ou rend possible
    - conditions: L'assertion spécifie une CONDITION liée au concept
    - causes: L'assertion décrit un EFFET ou conséquence du concept

    RÈGLE C3 - Éviter le "spray & pray":
    - Maximum 5 concepts par assertion
    - Ne lier que si confiance >= 0.70
    - Justifier chaque lien de manière précise

  user: |
    Établis les liens sémantiques entre ces assertions et ces concepts.

    ASSERTIONS (à lier):
    {assertions}

    CONCEPTS (cibles):
    {concepts}

    ⚠️ MULTI-CONCEPT: Une assertion peut être liée à PLUSIEURS concepts (1-5 max).

    Réponds UNIQUEMENT avec ce JSON:
    ```json
    {{
      "links": [
        {{
          "assertion_id": "assert_abc123",
          "concept_links": [
            {{
              "concept_id": "concept_xyz1",
              "link_type": "defines",
              "justification": "Cette assertion définit le concept car...",
              "confidence": 0.85
            }},
            {{
              "concept_id": "concept_xyz2",
              "link_type": "describes",
              "justification": "Cette assertion décrit aussi ce concept car...",
              "confidence": 0.75
            }}
          ]
        }}
      ],
      "unlinked_assertions": [
        {{
          "assertion_id": "assert_def456",
          "reason": "Cette assertion ne concerne aucun des concepts identifiés car..."
        }}
      ]
    }}
    ```

# ============================================================================
# PHASE 1.3 POINTER: Extraction Pointer-Based (Anti-Reformulation)
# ============================================================================
# Ce prompt utilise des unités numérotées pour éviter la reformulation LLM.
# Le LLM POINTE vers une unité (U1, U2...) au lieu de COPIER le texte.

pointer_concept_extraction:
  # FIX 2026-01-27: Labels doivent utiliser les mots du texte + supprimer value_kind
  system: |
    Tu es un expert en extraction de concepts pour OSMOSE.

    MÉTHODE POINTER-BASED:
    Le texte est découpé en unités numérotées (U1, U2, U3...).
    Tu dois POINTER vers l'unité qui contient le concept, PAS copier le texte.

    TYPES DE CONCEPTS:
    - PRESCRIPTIVE: Obligation, règle ("must", "shall", "required", "doit", "obligatoire")
    - DEFINITIONAL: Définition, explication ("is defined as", "refers to", "est défini")
    - FACTUAL: Information vérifiable, fait technique
    - PERMISSIVE: Option, possibilité ("may", "can", "peut", "optionnel")

    RÈGLES CRITIQUES:
    1. Retourne UNIQUEMENT le numéro d'unité (U1, U2...), JAMAIS le texte
    2. NE PROPOSE UN CONCEPT QUE SI TU PEUX POINTER UNE UNITÉ
    3. SI AUCUNE UNITÉ NE CORRESPOND, NE RETOURNE PAS LE CONCEPT
    4. ⚠️ Le LABEL doit contenir AU MOINS 2 MOTS présents dans le texte de l'unité
    5. ❌ NE PAS inventer de labels abstraits comme "security requirement" ou "data protection"
    6. ✅ UTILISER les mots exacts du texte pour construire le label

    FORMAT JSON STRICT - pas de texte hors JSON.

  user: |
    Extrais les concepts de ce texte avec unités numérotées.

    DOCITEM_ID: {docitem_id}
    LANGUE: {language}

    TEXTE AVEC UNITÉS:
    {units_text}

    INSTRUCTIONS CRITIQUES:
    - Indique UNIQUEMENT le numéro d'unité (U1, U2...).
    - NE RECOPIE PAS le texte complet.
    - ⚠️ Le LABEL doit utiliser des MOTS PRÉSENTS dans l'unité pointée.
    - ❌ INTERDIT: labels abstraits ("security requirement", "compliance standard")
    - ✅ CORRECT: labels avec mots du texte ("TLS version", "data encryption", "audit trail")

    EXEMPLES:
    - Unité: "TLS 1.2 is required" → label: "TLS version" ✅ (mots présents)
    - Unité: "All data must be encrypted" → label: "data encryption" ✅ (mots présents)
    - Unité: "All data must be encrypted" → label: "security requirement" ❌ (mots absents)

    Réponds UNIQUEMENT avec ce JSON:
    ```json
    {{
      "concepts": [
        {{
          "label": "Nom avec MOTS DU TEXTE (2-5 mots)",
          "type": "PRESCRIPTIVE|DEFINITIONAL|FACTUAL|PERMISSIVE",
          "unit_id": "U1",
          "confidence": 0.9
        }}
      ]
    }}
    ```

# ============================================================================
# PHASE 1.3 POINTER: Extraction par batch (plusieurs DocItems)
# ============================================================================

pointer_batch_extraction:
  # FIX 2026-01-27: Labels doivent utiliser les mots du texte
  system: |
    Expert extraction concepts OSMOSE - MODE BATCH POINTER.

    MÉTHODE:
    - Chaque bloc [DOCITEM: xxx] contient des unités numérotées
    - Tu dois POINTER vers les unités (U1, U2...) sans copier le texte
    - Inclure le docitem_id dans chaque concept extrait

    TYPES: PRESCRIPTIVE | DEFINITIONAL | FACTUAL | PERMISSIVE

    RÈGLES CRITIQUES:
    1. UNIQUEMENT le numéro d'unité, JAMAIS le texte
    2. Pas de concept si aucune unité ne correspond
    3. ⚠️ Le LABEL doit contenir AU MOINS 2 MOTS de l'unité pointée
    4. ❌ INTERDIT: labels abstraits (security requirement, data protection, compliance)
    5. ✅ UTILISER les mots exacts du texte

    FORMAT JSON COMPACT.

  user: |
    Extrais les concepts de ces DocItems.

    LANGUE: {language}

    {docitems_with_units}

    ⚠️ RÈGLE LABEL: Utilise des MOTS PRÉSENTS dans l'unité, pas des termes abstraits.

    Réponds avec ce JSON:
    ```json
    {{
      "concepts": [
        {{
          "docitem_id": "default:doc_abc:#/texts/5",
          "label": "Nom avec MOTS DU TEXTE",
          "type": "PRESCRIPTIVE",
          "unit_id": "U1",
          "confidence": 0.9
        }}
      ]
    }}
    ```

# ============================================================================
# PHASE 1.2b: Concept Refinement (Itératif - V2.1)
# ============================================================================
# Déclenché quand trop d'assertions sont en NO_CONCEPT_MATCH
# Analyse les assertions non-liées pour identifier les concepts manquants

concept_refinement:
  system: |
    Tu es un expert en identification de concepts MANQUANTS pour OSMOSE.

    CONTEXTE:
    On te donne des assertions qui N'ONT PAS PU être liées aux concepts existants.
    Ta tâche: identifier les concepts MANQUANTS qui permettraient de les capturer.

    RÈGLES CRITIQUES:
    - Concepts SPÉCIFIQUES et ACTIONNABLES (pas génériques)
    - Ne pas répéter les concepts existants
    - Maximum {max_concepts} nouveaux concepts par itération
    - Chaque concept doit correspondre à AU MOINS 2 assertions fournies

    ⚠️ CRITÈRE C2 - Assertions de qualité:
    Un nouveau concept doit couvrir au moins 1 assertion de qualité:
    - PRESCRIPTIVE (must, shall, required, obligatoire)
    - Value-bearing (contient une valeur: %, version, durée, taille)
    - Obligation implicite (is required to, no later than, within X days)

    ⚠️ LEXICAL TRIGGERS (C1):
    Chaque nouveau concept DOIT avoir 2-4 lexical_triggers:
    - Tokens qui APPARAISSENT dans les assertions fournies
    - Pas de paraphrases ou synonymes inventés

    EXEMPLES:
    Assertions non-liées:
    - "Data retention period is 5 years"
    - "Personal data must be deleted after retention"
    → Nouveau concept: {{"name": "période rétention données", "lexical_triggers": ["retention", "5 years", "deleted"]}}

  user: |
    Identifie les concepts MANQUANTS depuis ces assertions non-liées.

    ASSERTIONS NON LIÉES (extraits):
    {assertions}

    CONCEPTS EXISTANTS (à ne pas répéter):
    {existing_concepts}

    THÈMES DISPONIBLES:
    {themes}

    LANGUE: {language}

    RÈGLES:
    - Maximum {max_concepts} nouveaux concepts
    - Chaque concept doit couvrir ≥2 assertions dont ≥1 PRESCRIPTIVE ou value-bearing
    - Inclure 2-4 lexical_triggers par concept

    Réponds UNIQUEMENT avec ce JSON:
    ```json
    {{
      "new_concepts": [
        {{
          "name": "Nom spécifique (2-5 mots)",
          "role": "CENTRAL|STANDARD|CONTEXTUAL",
          "theme": "Thème existant",
          "lexical_triggers": ["token1", "token2", "token3"],
          "covers_assertions_count": 3,
          "has_prescriptive_or_value": true
        }}
      ],
      "uncapturable": [
        {{
          "reason": "Ces assertions sont trop génériques/fragmentaires pour justifier un concept"
        }}
      ]
    }}
    ```
